<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Jmds-svn] r53 - in trunk: applet/de/berlios/jmds/applet/javacard src src/de/berlios/jmds/applet src/de/berlios/jmds/client src/de/berlios/jmds/server src/de/berlios/jmds/tools src/fr/umlv/ir3/corba/forum test/de/berlios/jmds/clients test/de/berlios/jmds/tools
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/jmds-svn/2005-March/index.html" >
   <LINK REL="made" HREF="mailto:jmds-svn%40lists.berlios.de?Subject=Re%3A%20%5BJmds-svn%5D%20r53%20-%20in%20trunk%3A%20applet/de/berlios/jmds/applet/javacard%20src%20src/de/berlios/jmds/applet%20src/de/berlios/jmds/client%20src/de/berlios/jmds/server%20src/de/berlios/jmds/tools%20src/fr/umlv/ir3/corba/forum%20test/de/berlios/jmds/clients%20test/de/berlios/jmds/tools&In-Reply-To=%3C200503041308.j24D8np9018359%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000066.html">
   <LINK REL="Next"  HREF="000068.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Jmds-svn] r53 - in trunk: applet/de/berlios/jmds/applet/javacard src src/de/berlios/jmds/applet src/de/berlios/jmds/client src/de/berlios/jmds/server src/de/berlios/jmds/tools src/fr/umlv/ir3/corba/forum test/de/berlios/jmds/clients test/de/berlios/jmds/tools</H1>
    <B>J&#233;r&#244;me GUERS at BerliOS</B> 
    <A HREF="mailto:jmds-svn%40lists.berlios.de?Subject=Re%3A%20%5BJmds-svn%5D%20r53%20-%20in%20trunk%3A%20applet/de/berlios/jmds/applet/javacard%20src%20src/de/berlios/jmds/applet%20src/de/berlios/jmds/client%20src/de/berlios/jmds/server%20src/de/berlios/jmds/tools%20src/fr/umlv/ir3/corba/forum%20test/de/berlios/jmds/clients%20test/de/berlios/jmds/tools&In-Reply-To=%3C200503041308.j24D8np9018359%40sheep.berlios.de%3E"
       TITLE="[Jmds-svn] r53 - in trunk: applet/de/berlios/jmds/applet/javacard src src/de/berlios/jmds/applet src/de/berlios/jmds/client src/de/berlios/jmds/server src/de/berlios/jmds/tools src/fr/umlv/ir3/corba/forum test/de/berlios/jmds/clients test/de/berlios/jmds/tools">jguers at sheep.berlios.de
       </A><BR>
    <I>Fri Mar  4 14:08:49 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000066.html">[Jmds-svn] r52 - trunk/test/de/berlios/jmds/clients
</A></li>
        <LI>Next message: <A HREF="000068.html">[Jmds-svn] r54 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#67">[ date ]</a>
              <a href="thread.html#67">[ thread ]</a>
              <a href="subject.html#67">[ subject ]</a>
              <a href="author.html#67">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jguers
Date: 2005-03-04 14:08:48 +0100 (Fri, 04 Mar 2005)
New Revision: 53

Added:
   trunk/src/de/berlios/jmds/server/UserManagerAppletWithKeyClient.java
   trunk/test/de/berlios/jmds/clients/TestSCAppletWithKey.java
Modified:
   trunk/applet/de/berlios/jmds/applet/javacard/applet.ijc
   trunk/applet/de/berlios/jmds/applet/javacard/applet.jar
   trunk/applet/de/berlios/jmds/applet/javacard/applet.jca
   trunk/src/de/berlios/jmds/applet/SCApplet.java
   trunk/src/de/berlios/jmds/client/ClientInter.java
   trunk/src/de/berlios/jmds/client/SCAppletClient.java
   trunk/src/de/berlios/jmds/server/RightsManager.java
   trunk/src/de/berlios/jmds/server/SCManager.java
   trunk/src/de/berlios/jmds/server/ServerInter.java
   trunk/src/de/berlios/jmds/server/UserManagerAppletClient.java
   trunk/src/de/berlios/jmds/tools/Convertor.java
   trunk/src/de/berlios/jmds/tools/RightsConfiguration.java
   trunk/src/fr/umlv/ir3/corba/forum/ForumImpl.java
   trunk/src/fr/umlv/ir3/corba/forum/SlimForumClient.java
   trunk/src/security.xml
   trunk/test/de/berlios/jmds/clients/TestSCApplet.java
   trunk/test/de/berlios/jmds/tools/SecurityConfigurationTest.java
Log:
Creation d'une applet avec codage symetrique
Patch pour rendre le codage operationnel

Reste la gestion des droits + admin des IOR

Modified: trunk/applet/de/berlios/jmds/applet/javacard/applet.ijc
===================================================================
(Binary files differ)

Modified: trunk/applet/de/berlios/jmds/applet/javacard/applet.jar
===================================================================
(Binary files differ)

Modified: trunk/applet/de/berlios/jmds/applet/javacard/applet.jca
===================================================================
--- trunk/applet/de/berlios/jmds/applet/javacard/applet.jca	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/applet/de/berlios/jmds/applet/javacard/applet.jca	2005-03-04 13:08:48 UTC (rev 53)
@@ -1,5 +1,5 @@
 // converted by version 1.3
-// on Wed Mar 02 01:01:45 CET 2005
+// on Fri Mar 04 11:25:55 CET 2005
 
 .package de/berlios/jmds/applet {
 	.aid 0x11:0x22:0x33:0x44:0x55:0x66;
@@ -12,18 +12,18 @@
 	}
 
 	.applet {
-		0x11:0x22:0x33:0x44:0x55:0x66:0x77 SCAppletWithKey;
+		0x11:0x22:0x33:0x44:0x55:0x66:0x77 SCApplet;
 	}
 
 	.constantPool {
 		// 0
-		instanceFieldRef byte[] SCApplet/buffer;
+		instanceFieldRef byte[] SCApplet/userID;
 		// 1
-		instanceFieldRef byte[] SCApplet/code;
+		instanceFieldRef boolean SCApplet/userIDInit;
 		// 2
-		instanceFieldRef 1.14 SCApplet/randomer;
+		instanceFieldRef boolean SCApplet/serverKeyInit;
 		// 3
-		instanceFieldRef byte SCApplet/key;
+		instanceFieldRef byte[] SCApplet/serverKey;
 		// 4
 		instanceFieldRef byte[] SCAppletWithKey/userID;
 		// 5
@@ -35,91 +35,107 @@
 		// 8
 		instanceFieldRef 1.14 SCAppletWithKey/random;
 		// 9
-		virtualMethodRef 0.10.1()[B;		// javacard/framework/APDU.getBuffer()[B
-		// 10
 		staticMethodRef SCApplet/encode(Ljavacard/framework/APDU;)V;
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
+		// 10
+		staticMethodRef SCApplet/decode(Ljavacard/framework/APDU;)V;
+			.descriptor	Ljavacard/framework/APDU;	0.10;
+
 		// 11
-		staticMethodRef 0.7.1(S)V;		// javacard/framework/ISOException.throwIt(S)V
+		staticMethodRef SCApplet/setUserID(Ljavacard/framework/APDU;)V;
+			.descriptor	Ljavacard/framework/APDU;	0.10;
+
 		// 12
-		virtualMethodRef 0.10.6()S;		// javacard/framework/APDU.setIncomingAndReceive()S
+		staticMethodRef SCApplet/setServerKey(Ljavacard/framework/APDU;)V;
+			.descriptor	Ljavacard/framework/APDU;	0.10;
+
 		// 13
-		virtualMethodRef 1.14.1([BSS)V;		// javacard/security/RandomData.generateData([BSS)V
+		staticMethodRef 0.7.1(S)V;		// javacard/framework/ISOException.throwIt(S)V
 		// 14
+		virtualMethodRef 0.10.6()S;		// javacard/framework/APDU.setIncomingAndReceive()S
+		// 15
 		virtualMethodRef 0.10.7()S;		// javacard/framework/APDU.setOutgoing()S
-		// 15
-		virtualMethodRef 0.10.9(S)V;		// javacard/framework/APDU.setOutgoingLength(S)V
 		// 16
-		virtualMethodRef 0.10.5([BSS)V;		// javacard/framework/APDU.sendBytesLong([BSS)V
+		staticMethodRef SCApplet/crypt([BSS[BS[B)V;
 		// 17
-		staticMethodRef 0.3.0()V;		// javacard/framework/Applet.&lt;init&gt;()V
+		virtualMethodRef 0.10.9(S)V;		// javacard/framework/APDU.setOutgoingLength(S)V
 		// 18
-		staticMethodRef 1.14.0(B)Ljavacard/security/RandomData;;		// javacard/security/RandomData.getInstance(B)Ljavacard/security/RandomData;
-			.descriptor	Ljavacard/security/RandomData;	1.14;
-
+		virtualMethodRef 0.10.5([BSS)V;		// javacard/framework/APDU.sendBytesLong([BSS)V
 		// 19
+		staticMethodRef 0.3.0()V;		// javacard/framework/Applet.&lt;init&gt;()V
+		// 20
+		virtualMethodRef 0.3.1()V;		// javacard/framework/Applet.register()V
+		// 21
 		staticMethodRef 1.13.0(BSZ)Ljavacard/security/Key;;		// javacard/security/KeyBuilder.buildKey(BSZ)Ljavacard/security/Key;
 			.descriptor	Ljavacard/security/Key;	1.0;
 
-		// 20
+		// 22
 		classRef 1.9;		// javacard/security/RSAPublicKey
-		// 21
-		virtualMethodRef 0.3.1()V;		// javacard/framework/Applet.register()V
-		// 22
+		// 23
+		classRef SCApplet;
+		// 24
 		staticMethodRef 2.1.0(BZ)Ljavacardx/crypto/Cipher;;		// javacardx/crypto/Cipher.getInstance(BZ)Ljavacardx/crypto/Cipher;
 			.descriptor	Ljavacardx/crypto/Cipher;	2.1;
 
-		// 23
-		classRef SCApplet;
-		// 24
+		// 25
 		staticMethodRef SCApplet/&lt;init&gt;()V;
-		// 25
+		// 26
+		staticMethodRef 1.14.0(B)Ljavacard/security/RandomData;;		// javacard/security/RandomData.getInstance(B)Ljavacard/security/RandomData;
+			.descriptor	Ljavacard/security/RandomData;	1.14;
+
+		// 27
+		virtualMethodRef 0.10.1()[B;		// javacard/framework/APDU.getBuffer()[B
+		// 28
 		classRef SCAppletWithKey;
-		// 26
+		// 29
 		staticMethodRef SCAppletWithKey/&lt;init&gt;()V;
-		// 27
+		// 30
 		staticMethodRef SCAppletWithKey/encode(Ljavacard/framework/APDU;)V;
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-		// 28
+		// 31
 		staticMethodRef SCAppletWithKey/decode(Ljavacard/framework/APDU;)V;
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-		// 29
+		// 32
 		staticMethodRef SCAppletWithKey/setUserID(Ljavacard/framework/APDU;)V;
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-		// 30
+		// 33
 		staticMethodRef SCAppletWithKey/setSeverKeyExp(Ljavacard/framework/APDU;)V;
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-		// 31
+		// 34
 		staticMethodRef SCAppletWithKey/setServerKeyMod(Ljavacard/framework/APDU;)V;
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-		// 32
+		// 35
 		classRef 1.0;		// javacard/security/Key
-		// 33
+		// 36
+		virtualMethodRef 1.14.1([BSS)V;		// javacard/security/RandomData.generateData([BSS)V
+		// 37
 		virtualMethodRef 2.1.3(Ljavacard/security/Key;B)V;		// javacardx/crypto/Cipher.init(Ljavacard/security/Key;B)V
 			.descriptor	Ljavacard/security/Key;	1.0;
 
-		// 34
+		// 38
 		virtualMethodRef 2.1.1([BSS[BS)S;		// javacardx/crypto/Cipher.doFinal([BSS[BS)S
 	}
 
 	.class public SCApplet 0 extends 0.3 {		// extends javacard/framework/Applet
 
 		.fields {
-			private final 1.14 randomer 0;		// Ljavacard/security/RandomData;
-			private byte[] buffer 1;		// [B
-			private byte[] code 2;		// [B
-			private byte key 3;		// B
+			private byte[] userID 0;		// [B
+			private byte[] serverKey 1;		// [B
+			private boolean userIDInit 2;		// Z
+			private boolean serverKeyInit 3;		// Z
 			private static final byte CLA_SECURITY = 105;		// B
 			private static final byte INS_CODE = 16;		// B
-			private static final byte INS_DECODE = 48;		// B
-			private static final byte INS_SET_USER_KEY = 119;		// B
-			private static final short BUFFER_LENGTH = 32;		// S
+			private static final byte INS_DECODE = 32;		// B
+			private static final byte INS_SET_USER = 48;		// B
+			private static final byte INS_SET_SERVERKEY = 80;		// B
+			private static final short KEY_LENGTH = 5;		// S
+			private static final short USER_ID_LENGTH = 10;		// S
 		}
 
 		.publicMethodTable 7 {
@@ -141,24 +157,26 @@
 			.locals 0;
 
 				L0:	aload_0;
-					invokespecial 17;		// javacard/framework/Applet.&lt;init&gt;()V
+					invokespecial 19;		// javacard/framework/Applet.&lt;init&gt;()V
 					aload_0;
-					bspush 32;
+					aconst_null;
+					putfield_a 0;		// reference de/berlios/jmds/applet/SCApplet.userID
+					aload_0;
+					sconst_0;
+					putfield_b 1;		// boolean de/berlios/jmds/applet/SCApplet.userIDInit
+					aload_0;
+					sconst_0;
+					putfield_b 2;		// boolean de/berlios/jmds/applet/SCApplet.serverKeyInit
+					aload_0;
+					bspush 10;
 					newarray 11;
-					putfield_a 0;		// reference de/berlios/jmds/applet/SCApplet.buffer
+					putfield_a 0;		// reference de/berlios/jmds/applet/SCApplet.userID
 					aload_0;
-					bspush 32;
+					sconst_5;
 					newarray 11;
-					putfield_a 1;		// reference de/berlios/jmds/applet/SCApplet.code
+					putfield_a 3;		// reference de/berlios/jmds/applet/SCApplet.serverKey
 					aload_0;
-					sconst_2;
-					invokestatic 18;		// javacard/security/RandomData.getInstance(B)Ljavacard/security/RandomData;
-					putfield_a 2;		// reference de/berlios/jmds/applet/SCApplet.randomer
-					aload_0;
-					sconst_0;
-					putfield_b 3;		// byte de/berlios/jmds/applet/SCApplet.key
-					aload_0;
-					invokevirtual 21;		// javacard/framework/Applet.register()V
+					invokevirtual 20;		// javacard/framework/Applet.register()V
 					return;
 		}
 
@@ -167,93 +185,301 @@
 			.locals 0;
 
 				L0:	new 23;		// de/berlios/jmds/applet/SCApplet
-					invokespecial 24;		// de/berlios/jmds/applet/SCApplet.&lt;init&gt;()V
+					invokespecial 25;		// de/berlios/jmds/applet/SCApplet.&lt;init&gt;()V
 					return;
 		}
 
 		.method public process(Ljavacard/framework/APDU;)V 7 {
 			.stack 2;
-			.locals 0;
+			.locals 1;
 
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-				L0:	aload_0;
-					aload_1;
-					invokevirtual 9;		// javacard/framework/APDU.getBuffer()[B
-					putfield_a 0;		// reference de/berlios/jmds/applet/SCApplet.buffer
-					getfield_a_this 0;		// reference de/berlios/jmds/applet/SCApplet.buffer
+				L0:	aload_1;
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
+					astore_2;
+					aload_2;
 					sconst_0;
 					baload;
 					bspush 105;
-					if_scmpne L6;
-				L1:	getfield_a_this 0;		// reference de/berlios/jmds/applet/SCApplet.buffer
+					if_scmpne L7;
+				L1:	aload_2;
 					sconst_1;
 					baload;
-					slookupswitch L5 3 16 L2 48 L3 119 L4;
+					slookupswitch L6 4 16 L2 32 L3 48 L4 80 L5;
 				L2:	aload_0;
 					aload_1;
-					invokespecial 10;		// de/berlios/jmds/applet/SCApplet.encode(Ljavacard/framework/APDU;)V
-					goto L7;
-				L3:	goto L7;
-				L4:	goto L7;
-				L5:	sspush 27904;
-					invokestatic 11;		// javacard/framework/ISOException.throwIt(S)V
-					goto L7;
-				L6:	sspush 28160;
-					invokestatic 11;		// javacard/framework/ISOException.throwIt(S)V
-				L7:	return;
+					invokespecial 9;		// de/berlios/jmds/applet/SCApplet.encode(Ljavacard/framework/APDU;)V
+					goto L8;
+				L3:	aload_0;
+					aload_1;
+					invokespecial 10;		// de/berlios/jmds/applet/SCApplet.decode(Ljavacard/framework/APDU;)V
+					goto L8;
+				L4:	aload_0;
+					aload_1;
+					invokespecial 11;		// de/berlios/jmds/applet/SCApplet.setUserID(Ljavacard/framework/APDU;)V
+					goto L8;
+				L5:	aload_0;
+					aload_1;
+					invokespecial 12;		// de/berlios/jmds/applet/SCApplet.setServerKey(Ljavacard/framework/APDU;)V
+				L6:	goto L8;
+				L7:	sspush 28160;
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
+				L8:	return;
 		}
 
 		.method private encode(Ljavacard/framework/APDU;)V {
-			.stack 5;
-			.locals 2;
+			.stack 7;
+			.locals 5;
 
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-				L0:	aload_1;
-					invokevirtual 12;		// javacard/framework/APDU.setIncomingAndReceive()S
+				L0:	getfield_b_this 1;		// boolean de/berlios/jmds/applet/SCApplet.userIDInit
+					ifne L2;
+				L1:	sspush 27013;
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
+				L2:	getfield_b_this 2;		// boolean de/berlios/jmds/applet/SCApplet.serverKeyInit
+					ifne L4;
+				L3:	sspush 27013;
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
+				L4:	aload_1;
+					invokevirtual 14;		// javacard/framework/APDU.setIncomingAndReceive()S
 					sstore_2;
-					getfield_a_this 2;		// reference de/berlios/jmds/applet/SCApplet.randomer
-					getfield_a_this 1;		// reference de/berlios/jmds/applet/SCApplet.code
-					sconst_0;
-					bspush 32;
-					invokevirtual 13;		// javacard/security/RandomData.generateData([BSS)V
-					sconst_0;
-					sstore_3;
-					goto L2;
-				L1:	getfield_a_this 1;		// reference de/berlios/jmds/applet/SCApplet.code
-					sload_3;
-					getfield_b_this 3;		// byte de/berlios/jmds/applet/SCApplet.key
+					aload_1;
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
+					astore_3;
+					sload_2;
+					sconst_5;
 					sadd;
-					getfield_a_this 0;		// reference de/berlios/jmds/applet/SCApplet.buffer
-					sload_3;
+					bspush 10;
+					sadd;
+					newarray 11;
+					astore 4;
+					aload_1;
+					invokevirtual 15;		// javacard/framework/APDU.setOutgoing()S
+					sstore 5;
+					sload 5;
+					aload 4;
+					arraylength;
+					if_scmpge L6;
+				L5:	sspush 26368;
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
+				L6:	sconst_0;
+					sstore 6;
+					goto L8;
+				L7:	aload 4;
+					sload 6;
 					sconst_5;
 					sadd;
+					getfield_a_this 0;		// reference de/berlios/jmds/applet/SCApplet.userID
+					sload 6;
 					baload;
 					bastore;
-					sinc 3 1;
-				L2:	sload_3;
+					sinc 6 1;
+				L8:	sload 6;
+					bspush 10;
+					if_scmplt L7;
+				L9:	sconst_0;
+					sstore 6;
+					goto L11;
+				L10:	aload 4;
+					sload 6;
+					sconst_5;
+					sadd;
+					bspush 10;
+					sadd;
+					aload_3;
+					sload 6;
+					sconst_5;
+					sadd;
+					baload;
+					bastore;
+					sinc 6 1;
+				L11:	sload 6;
 					sload_2;
-					if_scmplt L1;
-				L3:	aload_1;
-					invokevirtual 14;		// javacard/framework/APDU.setOutgoing()S
-					sstore_3;
-					sload_3;
-					bspush 32;
-					if_scmpge L5;
-				L4:	sspush 26368;
-					invokestatic 11;		// javacard/framework/ISOException.throwIt(S)V
-				L5:	aload_1;
-					bspush 32;
-					invokevirtual 15;		// javacard/framework/APDU.setOutgoingLength(S)V
+					if_scmplt L10;
+				L12:	aload_0;
+					aload_3;
+					sconst_5;
+					sload_2;
+					aload 4;
+					sconst_0;
+					getfield_a_this 3;		// reference de/berlios/jmds/applet/SCApplet.serverKey
+					invokespecial 16;		// de/berlios/jmds/applet/SCApplet.crypt([BSS[BS[B)V
 					aload_1;
-					getfield_a_this 1;		// reference de/berlios/jmds/applet/SCApplet.code
+					aload 4;
+					arraylength;
+					invokevirtual 17;		// javacard/framework/APDU.setOutgoingLength(S)V
+					aload_1;
+					aload 4;
 					sconst_0;
-					bspush 32;
-					invokevirtual 16;		// javacard/framework/APDU.sendBytesLong([BSS)V
+					aload 4;
+					arraylength;
+					invokevirtual 18;		// javacard/framework/APDU.sendBytesLong([BSS)V
 					return;
 		}
 
+		.method private decode(Ljavacard/framework/APDU;)V {
+			.stack 7;
+			.locals 4;
+
+			.descriptor	Ljavacard/framework/APDU;	0.10;
+
+				L0:	getfield_b_this 2;		// boolean de/berlios/jmds/applet/SCApplet.serverKeyInit
+					ifne L2;
+				L1:	sspush 27013;
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
+				L2:	aload_1;
+					invokevirtual 14;		// javacard/framework/APDU.setIncomingAndReceive()S
+					sstore_2;
+					aload_1;
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
+					astore_3;
+					sload_2;
+					newarray 11;
+					astore 4;
+					aload_1;
+					invokevirtual 15;		// javacard/framework/APDU.setOutgoing()S
+					sstore 5;
+					sload 5;
+					aload 4;
+					arraylength;
+					if_scmpge L4;
+				L3:	sspush 26368;
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
+				L4:	aload_0;
+					aload_3;
+					sconst_5;
+					sload_2;
+					aload 4;
+					sconst_0;
+					getfield_a_this 3;		// reference de/berlios/jmds/applet/SCApplet.serverKey
+					invokespecial 16;		// de/berlios/jmds/applet/SCApplet.crypt([BSS[BS[B)V
+					aload_1;
+					aload 4;
+					arraylength;
+					invokevirtual 17;		// javacard/framework/APDU.setOutgoingLength(S)V
+					aload_1;
+					aload 4;
+					sconst_0;
+					aload 4;
+					arraylength;
+					invokevirtual 18;		// javacard/framework/APDU.sendBytesLong([BSS)V
+					return;
+		}
+
+		.method private setServerKey(Ljavacard/framework/APDU;)V {
+			.stack 5;
+			.locals 3;
+
+			.descriptor	Ljavacard/framework/APDU;	0.10;
+
+				L0:	aload_1;
+					invokevirtual 14;		// javacard/framework/APDU.setIncomingAndReceive()S
+					sstore_2;
+					aload_1;
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
+					astore_3;
+					sload_2;
+					sconst_5;
+					if_scmpeq L2;
+				L1:	sspush 26368;
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
+				L2:	sconst_0;
+					sstore 4;
+					goto L4;
+				L3:	getfield_a_this 3;		// reference de/berlios/jmds/applet/SCApplet.serverKey
+					sload 4;
+					aload_3;
+					sconst_5;
+					sload 4;
+					sadd;
+					baload;
+					bastore;
+					sinc 4 1;
+				L4:	sload 4;
+					sload_2;
+					if_scmplt L3;
+				L5:	aload_0;
+					sconst_1;
+					putfield_b 2;		// boolean de/berlios/jmds/applet/SCApplet.serverKeyInit
+					return;
+		}
+
+		.method private setUserID(Ljavacard/framework/APDU;)V {
+			.stack 5;
+			.locals 3;
+
+			.descriptor	Ljavacard/framework/APDU;	0.10;
+
+				L0:	aload_1;
+					invokevirtual 14;		// javacard/framework/APDU.setIncomingAndReceive()S
+					sstore_2;
+					aload_1;
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
+					astore_3;
+					sload_2;
+					bspush 10;
+					if_scmpeq L2;
+				L1:	sspush 26368;
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
+				L2:	sconst_0;
+					sstore 4;
+					goto L4;
+				L3:	getfield_a_this 0;		// reference de/berlios/jmds/applet/SCApplet.userID
+					sload 4;
+					aload_3;
+					sconst_5;
+					sload 4;
+					sadd;
+					baload;
+					bastore;
+					sinc 4 1;
+				L4:	sload 4;
+					sload_2;
+					if_scmplt L3;
+				L5:	aload_0;
+					sconst_1;
+					putfield_b 1;		// boolean de/berlios/jmds/applet/SCApplet.userIDInit
+					return;
+		}
+
+		.method private crypt([BSS[BS[B)V {
+			.stack 5;
+			.locals 2;
+
+				L0:	sconst_0;
+					sstore 7;
+					sconst_0;
+					sstore 8;
+					goto L2;
+				L1:	aload 4;
+					sload 8;
+					sload 5;
+					sadd;
+					aload_1;
+					sload 8;
+					sload_2;
+					sadd;
+					baload;
+					aload 6;
+					sload 7;
+					baload;
+					sxor;
+					bastore;
+					sload 7;
+					sconst_1;
+					sadd;
+					sconst_5;
+					srem;
+					sstore 7;
+					sinc 8 1;
+				L2:	sload 8;
+					sload_3;
+					if_scmplt L1;
+				L3:	return;
+		}
+
 	}
 
 	.class public SCAppletWithKey 1 extends 0.3 {		// extends javacard/framework/Applet
@@ -293,7 +519,7 @@
 			.locals 0;
 
 				L0:	aload_0;
-					invokespecial 17;		// javacard/framework/Applet.&lt;init&gt;()V
+					invokespecial 19;		// javacard/framework/Applet.&lt;init&gt;()V
 					aload_0;
 					aconst_null;
 					putfield_a 4;		// reference de/berlios/jmds/applet/SCAppletWithKey.userID
@@ -305,20 +531,20 @@
 					sconst_4;
 					sspush 512;
 					sconst_1;
-					invokestatic 19;		// javacard/security/KeyBuilder.buildKey(BSZ)Ljavacard/security/Key;
-					checkcast 0 20;		// T_CLASSORINTERFACE javacard/security/RSAPublicKey
+					invokestatic 21;		// javacard/security/KeyBuilder.buildKey(BSZ)Ljavacard/security/Key;
+					checkcast 0 22;		// T_CLASSORINTERFACE javacard/security/RSAPublicKey
 					putfield_a 6;		// reference de/berlios/jmds/applet/SCAppletWithKey.serverKey
 					aload_0;
 					bspush 10;
 					sconst_0;
-					invokestatic 22;		// javacardx/crypto/Cipher.getInstance(BZ)Ljavacardx/crypto/Cipher;
+					invokestatic 24;		// javacardx/crypto/Cipher.getInstance(BZ)Ljavacardx/crypto/Cipher;
 					putfield_a 7;		// reference de/berlios/jmds/applet/SCAppletWithKey.cipher
 					aload_0;
 					sconst_2;
-					invokestatic 18;		// javacard/security/RandomData.getInstance(B)Ljavacard/security/RandomData;
+					invokestatic 26;		// javacard/security/RandomData.getInstance(B)Ljavacard/security/RandomData;
 					putfield_a 8;		// reference de/berlios/jmds/applet/SCAppletWithKey.random
 					aload_0;
-					invokevirtual 21;		// javacard/framework/Applet.register()V
+					invokevirtual 20;		// javacard/framework/Applet.register()V
 					return;
 		}
 
@@ -326,8 +552,8 @@
 			.stack 1;
 			.locals 0;
 
-				L0:	new 25;		// de/berlios/jmds/applet/SCAppletWithKey
-					invokespecial 26;		// de/berlios/jmds/applet/SCAppletWithKey.&lt;init&gt;()V
+				L0:	new 28;		// de/berlios/jmds/applet/SCAppletWithKey
+					invokespecial 29;		// de/berlios/jmds/applet/SCAppletWithKey.&lt;init&gt;()V
 					return;
 		}
 
@@ -338,7 +564,7 @@
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
 				L0:	aload_1;
-					invokevirtual 9;		// javacard/framework/APDU.getBuffer()[B
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
 					astore_2;
 					aload_2;
 					sconst_0;
@@ -351,23 +577,23 @@
 					slookupswitch L7 5 16 L2 32 L3 48 L4 68 L6 102 L5;
 				L2:	aload_0;
 					aload_1;
-					invokespecial 27;		// de/berlios/jmds/applet/SCAppletWithKey.encode(Ljavacard/framework/APDU;)V
+					invokespecial 30;		// de/berlios/jmds/applet/SCAppletWithKey.encode(Ljavacard/framework/APDU;)V
 					goto L7;
 				L3:	aload_0;
 					aload_1;
-					invokespecial 28;		// de/berlios/jmds/applet/SCAppletWithKey.decode(Ljavacard/framework/APDU;)V
+					invokespecial 31;		// de/berlios/jmds/applet/SCAppletWithKey.decode(Ljavacard/framework/APDU;)V
 					goto L7;
 				L4:	aload_0;
 					aload_1;
-					invokespecial 29;		// de/berlios/jmds/applet/SCAppletWithKey.setUserID(Ljavacard/framework/APDU;)V
+					invokespecial 32;		// de/berlios/jmds/applet/SCAppletWithKey.setUserID(Ljavacard/framework/APDU;)V
 					goto L7;
 				L5:	aload_0;
 					aload_1;
-					invokespecial 30;		// de/berlios/jmds/applet/SCAppletWithKey.setSeverKeyExp(Ljavacard/framework/APDU;)V
+					invokespecial 33;		// de/berlios/jmds/applet/SCAppletWithKey.setSeverKeyExp(Ljavacard/framework/APDU;)V
 					goto L7;
 				L6:	aload_0;
 					aload_1;
-					invokespecial 31;		// de/berlios/jmds/applet/SCAppletWithKey.setServerKeyMod(Ljavacard/framework/APDU;)V
+					invokespecial 34;		// de/berlios/jmds/applet/SCAppletWithKey.setServerKeyMod(Ljavacard/framework/APDU;)V
 				L7:	return;
 		}
 
@@ -380,17 +606,17 @@
 				L0:	getfield_a_this 4;		// reference de/berlios/jmds/applet/SCAppletWithKey.userID
 					ifnonnull L2;
 				L1:	sspush 27013;
-					invokestatic 11;		// javacard/framework/ISOException.throwIt(S)V
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
 				L2:	getfield_a_this 6;		// reference de/berlios/jmds/applet/SCAppletWithKey.serverKey
-					invokeinterface 1 32 3;		// javacard/security/Key
+					invokeinterface 1 35 3;		// javacard/security/Key
 					ifne L4;
 				L3:	sspush 27013;
-					invokestatic 11;		// javacard/framework/ISOException.throwIt(S)V
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
 				L4:	aload_1;
-					invokevirtual 12;		// javacard/framework/APDU.setIncomingAndReceive()S
+					invokevirtual 14;		// javacard/framework/APDU.setIncomingAndReceive()S
 					sstore_2;
 					aload_1;
-					invokevirtual 9;		// javacard/framework/APDU.getBuffer()[B
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
 					astore_3;
 					sload_2;
 					sconst_5;
@@ -403,7 +629,7 @@
 					getfield_a_this 5;		// reference de/berlios/jmds/applet/SCAppletWithKey.sessionKey
 					sconst_0;
 					sconst_5;
-					invokevirtual 13;		// javacard/security/RandomData.generateData([BSS)V
+					invokevirtual 36;		// javacard/security/RandomData.generateData([BSS)V
 					sconst_0;
 					sstore 5;
 					goto L6;
@@ -454,7 +680,7 @@
 				L13:	getfield_a_this 7;		// reference de/berlios/jmds/applet/SCAppletWithKey.cipher
 					getfield_a_this 6;		// reference de/berlios/jmds/applet/SCAppletWithKey.serverKey
 					sconst_2;
-					invokevirtual 33;		// javacardx/crypto/Cipher.init(Ljavacard/security/Key;B)V
+					invokevirtual 37;		// javacardx/crypto/Cipher.init(Ljavacard/security/Key;B)V
 					getfield_a_this 7;		// reference de/berlios/jmds/applet/SCAppletWithKey.cipher
 					aload 4;
 					sconst_0;
@@ -465,24 +691,24 @@
 					sadd;
 					aload 4;
 					sconst_0;
-					invokevirtual 34;		// javacardx/crypto/Cipher.doFinal([BSS[BS)S
+					invokevirtual 38;		// javacardx/crypto/Cipher.doFinal([BSS[BS)S
 					sstore 5;
 					aload_1;
-					invokevirtual 14;		// javacard/framework/APDU.setOutgoing()S
+					invokevirtual 15;		// javacard/framework/APDU.setOutgoing()S
 					sstore 6;
 					sload 6;
 					sload 5;
 					if_scmpge L15;
 				L14:	sspush 26368;
-					invokestatic 11;		// javacard/framework/ISOException.throwIt(S)V
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
 				L15:	aload_1;
 					sload 5;
-					invokevirtual 15;		// javacard/framework/APDU.setOutgoingLength(S)V
+					invokevirtual 17;		// javacard/framework/APDU.setOutgoingLength(S)V
 					aload_1;
 					aload 4;
 					sconst_0;
 					sload 5;
-					invokevirtual 16;		// javacard/framework/APDU.sendBytesLong([BSS)V
+					invokevirtual 18;		// javacard/framework/APDU.sendBytesLong([BSS)V
 					return;
 		}
 
@@ -493,10 +719,10 @@
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
 				L0:	aload_1;
-					invokevirtual 12;		// javacard/framework/APDU.setIncomingAndReceive()S
+					invokevirtual 14;		// javacard/framework/APDU.setIncomingAndReceive()S
 					sstore_2;
 					aload_1;
-					invokevirtual 9;		// javacard/framework/APDU.getBuffer()[B
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
 					astore_3;
 					sconst_0;
 					sstore 4;
@@ -538,16 +764,16 @@
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
 				L0:	aload_1;
-					invokevirtual 12;		// javacard/framework/APDU.setIncomingAndReceive()S
+					invokevirtual 14;		// javacard/framework/APDU.setIncomingAndReceive()S
 					sstore_2;
 					aload_1;
-					invokevirtual 9;		// javacard/framework/APDU.getBuffer()[B
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
 					astore_3;
 					getfield_a_this 6;		// reference de/berlios/jmds/applet/SCAppletWithKey.serverKey
 					aload_3;
 					sconst_5;
 					sload_2;
-					invokeinterface 4 20 7;		// javacard/security/RSAPublicKey
+					invokeinterface 4 22 7;		// javacard/security/RSAPublicKey
 					return;
 		}
 
@@ -558,16 +784,16 @@
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
 				L0:	aload_1;
-					invokevirtual 12;		// javacard/framework/APDU.setIncomingAndReceive()S
+					invokevirtual 14;		// javacard/framework/APDU.setIncomingAndReceive()S
 					sstore_2;
 					aload_1;
-					invokevirtual 9;		// javacard/framework/APDU.getBuffer()[B
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
 					astore_3;
 					getfield_a_this 6;		// reference de/berlios/jmds/applet/SCAppletWithKey.serverKey
 					aload_3;
 					sconst_5;
 					sload_2;
-					invokeinterface 4 20 6;		// javacard/security/RSAPublicKey
+					invokeinterface 4 22 6;		// javacard/security/RSAPublicKey
 					return;
 		}
 
@@ -578,16 +804,16 @@
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
 				L0:	aload_1;
-					invokevirtual 12;		// javacard/framework/APDU.setIncomingAndReceive()S
+					invokevirtual 14;		// javacard/framework/APDU.setIncomingAndReceive()S
 					sstore_2;
 					aload_1;
-					invokevirtual 9;		// javacard/framework/APDU.getBuffer()[B
+					invokevirtual 27;		// javacard/framework/APDU.getBuffer()[B
 					astore_3;
 					sload_2;
 					bspush 10;
 					if_scmpeq L2;
 				L1:	sspush 26368;
-					invokestatic 11;		// javacard/framework/ISOException.throwIt(S)V
+					invokestatic 13;		// javacard/framework/ISOException.throwIt(S)V
 				L2:	sconst_0;
 					sstore 4;
 					goto L4;

Modified: trunk/src/de/berlios/jmds/applet/SCApplet.java
===================================================================
--- trunk/src/de/berlios/jmds/applet/SCApplet.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/applet/SCApplet.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -9,7 +9,7 @@
 import javacard.framework.Applet;
 import javacard.framework.ISOException;
 import javacard.framework.ISO7816;
-import javacard.security.RandomData;
+//import javacard.security.RandomData;
 
 /**
  * DOCME
@@ -23,26 +23,30 @@
     private final static byte CLA_SECURITY = (byte) 0x69;
     
     private final static byte INS_CODE = (byte) 0x10;
-    private final static byte INS_DECODE = (byte) 0x30;
-    private final static byte INS_SET_USER_KEY = (byte) 0x77;
+    private final static byte INS_DECODE = (byte) 0x20;
+    private final static byte INS_SET_USER = (byte) 0x30;
+    private final static byte INS_SET_SERVERKEY = (byte) 0x50;
     
-    private final static short BUFFER_LENGTH = (short) 0x20;
+    private final static short KEY_LENGTH = (short) 5;
+    private final static short USER_ID_LENGTH = (short) 10;
 
-    private final RandomData randomer;
-    
-    private byte[] buffer;
-    private byte[] code;
-    private byte key;
+//    private RandomData random;
+    private byte[] userID = null;
+    private byte[] serverKey;
+//    private byte[] sessionKey;
+    private boolean userIDInit = false;
+    private boolean serverKeyInit = false;
+//    private boolean sessionKeyInit = false;
 
     
     /**
      * Constructeur par d&#233;faut
      */
     protected SCApplet() {
-        buffer = new byte[BUFFER_LENGTH];
-        code = new byte[BUFFER_LENGTH];
-        randomer = RandomData.getInstance(RandomData.ALG_SECURE_RANDOM);
-        key = (byte)0;
+        userID = new byte[USER_ID_LENGTH];
+        serverKey = new byte[KEY_LENGTH];
+//        sessionKey = new byte[KEY_LENGTH];
+//        random = RandomData.getInstance(RandomData.ALG_SECURE_RANDOM);
         register();
     }
 
@@ -62,22 +66,15 @@
      * @see javacard.framework.Applet#process(javacard.framework.APDU)
      */
     public void process(APDU apdu) throws ISOException {
-        buffer = apdu.getBuffer();
+        byte[] inBuffer = apdu.getBuffer();
 
-        if (buffer[ISO7816.OFFSET_CLA] == CLA_SECURITY) {
-            switch (buffer[ISO7816.OFFSET_INS]) {
-                case INS_CODE:
-                    encode(apdu);
-                    break;
-                
-                case INS_DECODE:
-                    break;
+        if (inBuffer[ISO7816.OFFSET_CLA] == CLA_SECURITY) {
+            switch (inBuffer[ISO7816.OFFSET_INS]) {
+                case INS_CODE: encode(apdu); break;
+                case INS_DECODE: decode(apdu); break;
                     
-                case INS_SET_USER_KEY:
-                    break;
-                    
-                default:
-                    ISOException.throwIt(ISO7816.SW_INS_NOT_SUPPORTED);
+                case INS_SET_USER : setUserID(apdu); break;
+                case INS_SET_SERVERKEY : setServerKey(apdu); break;
             }
         }
         else
@@ -86,17 +83,115 @@
     
     private void encode(APDU apdu)
     {
-        short messLength = apdu.setIncomingAndReceive();
-        randomer.generateData(code, (short) 0, BUFFER_LENGTH);
-        for (short i = 0; i &lt; messLength; i++) {
-            code[(short)(i + key)] = buffer[(short)(i + ISO7816.OFFSET_CDATA)];
+        if(userIDInit == false)
+            ISOException.throwIt(ISO7816.SW_CONDITIONS_NOT_SATISFIED);
+        if(serverKeyInit == false)
+            ISOException.throwIt(ISO7816.SW_CONDITIONS_NOT_SATISFIED);
+        
+        short byteRead = apdu.setIncomingAndReceive();
+        byte[] inBuffer = apdu.getBuffer();
+        byte[] code = new byte[(short)(byteRead + KEY_LENGTH + USER_ID_LENGTH)];
+        
+        short Le = apdu.setOutgoing();
+        if (Le &lt; (short)(code.length))
+            ISOException.throwIt(ISO7816.SW_WRONG_LENGTH);
+
+//        random.generateData(sessionKey, (short)0, KEY_LENGTH);
+//        sessionKeyInit = true;
+//        for (short i = 0; i &lt; KEY_LENGTH; i++) {
+//            code[i] = sessionKey[i];
+//        }
+
+        for (short i = 0; i &lt; USER_ID_LENGTH; i++) {
+            code[(short)(i + KEY_LENGTH)] = userID[i];
         }
+
+        for (short i = 0; i &lt; byteRead; i++) {
+            code[(short)(i + KEY_LENGTH + USER_ID_LENGTH)] = inBuffer[(short) (i + ISO7816.OFFSET_CDATA)];
+        }
         
+        crypt(inBuffer, (short)ISO7816.OFFSET_CDATA, byteRead, code, (short)0, serverKey);
+
+        apdu.setOutgoingLength((short)code.length); 
+        apdu.sendBytesLong(code, (short)0, (short)code.length);
+    }
+    
+    /** 
+     * DOCME
+     *
+     * @param apdu 
+     */
+    private void decode(APDU apdu) {
+        if(serverKeyInit == false)
+            ISOException.throwIt(ISO7816.SW_CONDITIONS_NOT_SATISFIED);
+
+//        if(sessionKeyInit == false)
+//            ISOException.throwIt(ISO7816.SW_CONDITIONS_NOT_SATISFIED);
+        
+        short byteRead = apdu.setIncomingAndReceive();
+        byte[] inBuffer = apdu.getBuffer();
+        byte[] code = new byte[byteRead];
+        
         short Le = apdu.setOutgoing();
-        // Verification que Le &gt;= Lc (taille des donn&#233;es envoy&#233;es)
-        if (Le &lt; BUFFER_LENGTH)
+        if (Le &lt; (short)(code.length))
             ISOException.throwIt(ISO7816.SW_WRONG_LENGTH);
-        apdu.setOutgoingLength(BUFFER_LENGTH);
-        apdu.sendBytesLong(code, (short) 0, BUFFER_LENGTH);
+        
+        crypt(inBuffer, (short)ISO7816.OFFSET_CDATA, byteRead, code, (short)0, serverKey);
+//        sessionKeyInit = false;
+        
+        apdu.setOutgoingLength((short)code.length); 
+        apdu.sendBytesLong(code, (short)0, (short)code.length);
     }
+    
+    /** 
+     * DOCME
+     *
+     * @param apdu 
+     */
+    private void setServerKey(APDU apdu) {
+        short byteRead = apdu.setIncomingAndReceive();
+        byte[] inBuffer = apdu.getBuffer();
+        
+        if(byteRead != KEY_LENGTH)
+            ISOException.throwIt(ISO7816.SW_WRONG_LENGTH);
+        
+        for (short i = 0; i &lt; byteRead; i++) {
+            serverKey[i] = inBuffer[(short)(ISO7816.OFFSET_CDATA + i)];
+        }
+        serverKeyInit = true;    }
+
+    /** 
+     * DOCME
+     *
+     * @param apdu 
+     */
+    private void setUserID(APDU apdu) {
+        short byteRead = apdu.setIncomingAndReceive();
+        byte[] inBuffer = apdu.getBuffer();
+        
+        if(byteRead != USER_ID_LENGTH)
+            ISOException.throwIt(ISO7816.SW_WRONG_LENGTH);
+        
+        for (short i = 0; i &lt; byteRead; i++) {
+            userID[i] = inBuffer[(short)(ISO7816.OFFSET_CDATA + i)];
+        }
+        userIDInit = true;
+    }
+    
+    /** 
+     * DOCME
+     *
+     * @param inBuffer
+     * @param inOffset
+     * @param inLength
+     * @param outBuffer
+     * @param outOffset
+     */
+    private void crypt(byte[] inBuffer, short inOffset, short inLength, byte[] outBuffer, short outOffset, byte[] key) {
+        short cleInd = 0;
+        for(short i = 0 ; i &lt; inLength ; i++ ) {
+            outBuffer[(short)(i + outOffset)] = (byte)(inBuffer[(short)(i + inOffset)] ^ key[cleInd]);
+            cleInd = (short)(((short)(cleInd + 1)) % KEY_LENGTH);
+        }
+    }
 }

Modified: trunk/src/de/berlios/jmds/client/ClientInter.java
===================================================================
--- trunk/src/de/berlios/jmds/client/ClientInter.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/client/ClientInter.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -38,17 +38,17 @@
      * @see org.omg.PortableInterceptor.ClientRequestInterceptorOperations#send_request(org.omg.PortableInterceptor.ClientRequestInfo)
      */
     public void send_request(ClientRequestInfo ri) throws ForwardRequest, SecurityException{
+        System.out.println(&quot;ClientInter.send_request request: &quot; + ri.request_id());
         int id = ri.request_id();
         byte[] tabId = Integer.toString(id).getBytes();
         
-        // La m&#233;thode magique !!
-        System.out.println(&quot;Target= &quot;+ ri.target());
-
         try {
             byte[] tabByteSC = SCAppletClient.code(tabId);
         	ServiceContext sc = new ServiceContext ();
             sc.context_data = tabByteSC;
             ri.add_request_service_context(sc,true);
+        } catch (SecurityException e) {
+            e.printStackTrace();
         } catch (slbException e) {
             throw new SecurityException(&quot;Impossible de coder le message: erreur de communication avec la carte&quot;, e);
         }
@@ -58,44 +58,52 @@
      * @see org.omg.PortableInterceptor.ClientRequestInterceptorOperations#send_poll(org.omg.PortableInterceptor.ClientRequestInfo)
      */
     public void send_poll(ClientRequestInfo ri) {
-        System.out.println(&quot;ClientInter.send poll: &quot; + ri.operation());
+        System.out.println(&quot;ClientInter.send_poll request: &quot; + ri.request_id());
     }
 
     /**
      * @see org.omg.PortableInterceptor.ClientRequestInterceptorOperations#receive_reply(org.omg.PortableInterceptor.ClientRequestInfo)
      */
     public void receive_reply(ClientRequestInfo ri) {
-        System.out.println(&quot;ClientInter.receive reply: &quot; + ri.operation()
-                + &quot; number: &quot; + ri.request_id());
-        // ServiceContext sc = ri.get_reply_service_context(0);
-        // String sData = new String(sc.context_data);
+        System.out.println(&quot;ClientInter.receive_reply request: &quot; + ri.request_id());
+        ServiceContext sc = ri.get_reply_service_context(0);
+        
+        try {
+            short[] scDecode = SCAppletClient.decode (sc.context_data);
+            System.out.println (scDecode);
+        } catch (SecurityException e) {
+            e.printStackTrace();
+        } catch (slbException e) {
+            e.printStackTrace();
+            throw new SecurityException(&quot;Impossible de d&#233;coder le message: erreur de communication avec la carte&quot;, e);
+        }
     }
 
     /**
      * @see org.omg.PortableInterceptor.ClientRequestInterceptorOperations#receive_exception(org.omg.PortableInterceptor.ClientRequestInfo)
      */
     public void receive_exception(ClientRequestInfo ri) throws ForwardRequest {
-        System.out.println(&quot;ClientInter.receive exception: &quot;+ ri.operation());
+        System.out.println(&quot;ClientInter.receive request: &quot;+ ri.request_id());
     }
 
     /**
      * @see org.omg.PortableInterceptor.ClientRequestInterceptorOperations#receive_other(org.omg.PortableInterceptor.ClientRequestInfo)
      */
     public void receive_other(ClientRequestInfo ri) throws ForwardRequest {
-        System.out.println(&quot;ClientInter.receive other: &quot; + ri.operation());
+        System.out.println(&quot;ClientInter.receive request: &quot; + ri.request_id());
     }
 
     /**
      * @see org.omg.PortableInterceptor.InterceptorOperations#name()
      */
     public String name() {
-        return &quot;Mon intercepteur&quot;;
+        return &quot;JMDS intercepteur&quot;;
     }
 
     /**
      * @see org.omg.PortableInterceptor.InterceptorOperations#destroy()
      */
     public void destroy() {
-        System.out.println(&quot;Security Interceptor killed !!&quot;);
+        System.out.println(&quot;Client Security Interceptor killed !!&quot;);
     }
 }

Modified: trunk/src/de/berlios/jmds/client/SCAppletClient.java
===================================================================
--- trunk/src/de/berlios/jmds/client/SCAppletClient.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/client/SCAppletClient.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -34,9 +34,10 @@
      * @throws slbException 
      * @throws SecurityException 
      */
-    public static byte[] code(byte[] requestId) throws SecurityException, slbException {
-        int[] body = Convertor.stringToIntArray(&quot;555555&quot;);
-        byte[] code = Convertor.shortArrayToByteArray(AppletManager.sendCardAPDU(CLA_SECURITY, INS_CODE, 0, 0, body, 0x40));
+    public final static byte[] code(byte[] requestId) throws SecurityException, slbException {
+        int[] intRequestId = Convertor.ByteArrayToIntArray(requestId);
+        short[] tmpCode = AppletManager.sendCardAPDU(CLA_SECURITY, INS_CODE, 0, 0, intRequestId, 0x40);
+        byte[] code = Convertor.ShortArrayToByteArray(tmpCode);
         return code;
     }
 
@@ -47,9 +48,8 @@
      * @throws slbException 
      * @throws SecurityException 
      */
-    public static byte[] decode(byte[] SC) throws SecurityException, slbException {
-        int[] body = Convertor.stringToIntArray(&quot;555555&quot;);
-        byte[] decode = Convertor.shortArrayToByteArray(AppletManager.sendCardAPDU(CLA_SECURITY, INS_DECODE, 0, 0, body, 0x40));
-        return decode;
+    public final static short[] decode(byte[] sc) throws SecurityException, slbException {
+        int[] intRequestId = Convertor.ByteArrayToIntArray(sc);
+        return AppletManager.sendCardAPDU(CLA_SECURITY, INS_DECODE, 0, 0, intRequestId, 0x40);
     }
 }

Modified: trunk/src/de/berlios/jmds/server/RightsManager.java
===================================================================
--- trunk/src/de/berlios/jmds/server/RightsManager.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/server/RightsManager.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -25,10 +25,6 @@
 	/** The rights configuration **/
 	private RightsConfiguration rightsConfig		= RightsConfiguration.getInstance();
 	
-	
-	
-	
-	
 	/** The singleton instance * */
 	private static RightsManager INSTANCE = null;
 	
@@ -40,7 +36,10 @@
 	 * Constructor
 	 *  
 	 */
-	private RightsManager (){}
+	private RightsManager (){
+     rightsConfig = RightsConfiguration.getInstance();
+     securityConfig = SecurityConfiguration.getInstance();
+    }
 	
 	//----------------------------------------------------------//
 	//------------------- PUBLIC METHODS -----------------------//

Modified: trunk/src/de/berlios/jmds/server/SCManager.java
===================================================================
--- trunk/src/de/berlios/jmds/server/SCManager.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/server/SCManager.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -12,66 +12,98 @@
 
 import de.berlios.jmds.tools.SecurityConfiguration;
 
-
 /**
  * @author Denis
- *
+ * 
  */
 public class SCManager {
-	/** The security configuration **/
-	private SecurityConfiguration securityConfig = SecurityConfiguration.getInstance();
-	
-	/** The singleton instance * */
-	private static SCManager INSTANCE = null;
-	
-	//----------------------------------------------------------//
-	//------------------- CONSTRUCTORS -------------------------//
-	//----------------------------------------------------------//
-	
-	/**
-	 * Constructor
-	 *  
-	 */
-	private SCManager ()
-	{
-		// TODO Implante le contructeur
-	}
-	
-	//----------------------------------------------------------//
-	//------------------- PUBLIC METHODS -----------------------//
-	//----------------------------------------------------------//
+    /** The security configuration * */
+    private SecurityConfiguration securityConfig = SecurityConfiguration.getInstance();
 
-	
-	/**
-	 * To get the singleton instance of SCManager
-	 * 
-	 * @return the singleton instance of SCManager
-	 */
-	public static SCManager getInstance ()
-	{
-		if (INSTANCE == null)
-			INSTANCE = new SCManager ();
-		
-		return INSTANCE;
-	}
-	
-	/**
-	 * @param RequestId as id of the request message
-	 * @return The array byte which contains the encoding servec context
-	 */
-	public byte[] code (byte[] RequestId)
-	{
-		// TODO
-		return null;
-	}
-	
-	/**
-	 * @param SC as the message service context
-	 * @return the request id of the message
-	 */
-	public int decode (byte[] SC)
-	{
-		// TODO
-		return 0;		
-	}
+    /** The singleton instance * */
+    private static SCManager INSTANCE = null;
+    
+    private byte[] serverKey;
+
+    // ----------------------------------------------------------//
+    // ------------------- CONSTRUCTORS -------------------------//
+    // ----------------------------------------------------------//
+
+    /**
+     * Constructor
+     * 
+     */
+    private SCManager() {
+        setDefaultServerKey();
+    }
+
+    // ----------------------------------------------------------//
+    // ------------------- PUBLIC METHODS -----------------------//
+    // ----------------------------------------------------------//
+    /**
+     * To get the singleton instance of SCManager
+     * 
+     * @return the singleton instance of SCManager
+     */
+    public static SCManager getInstance() {
+        if (INSTANCE == null)
+            INSTANCE = new SCManager();
+
+        return INSTANCE;
+    }
+    
+    public void setServerKey(byte[] key) {
+        this.serverKey = key;
+    }
+
+    public void setDefaultServerKey() {
+        setServerKey(securityConfig.getServerKey().getBytes());
+    }
+
+    /**
+     * @param RequestId
+     *            as id of the request message
+     * @return The array byte which contains the encoding servec context
+     */
+    public byte[] code(byte[] sc) {
+        if(serverKey == null)
+            throw new SecurityException(&quot;Cl&#233; de serveur non initialis&#233;e&quot;);
+        
+        byte[] code = new byte[sc.length];
+        crypt(sc, 0, sc.length, code, 0, serverKey);
+        
+        return code;        
+    }
+
+    /**
+     * @param SC
+     *            as the message service context
+     * @return the request id of the message
+     */
+    public byte[] decode(byte[] sc) {
+        if(serverKey == null)
+            throw new SecurityException(&quot;Cl&#233; de serveur non initialis&#233;e&quot;);
+
+        byte[] code = new byte[sc.length];
+        crypt(sc, 0, sc.length, code, 0, serverKey);
+        
+        return code;        
+    }
+
+    /**
+     * DOCME
+     * 
+     * @param inBuffer
+     * @param inOffset
+     * @param inLength
+     * @param outBuffer
+     * @param outOffset
+     */
+    private void crypt(byte[] inBuffer, int inOffset, int inLength,byte[] outBuffer, int outOffset, byte[] key) {
+        int cleInd = 0;
+        for (int i = 0; i &lt; inLength; i++) {
+            outBuffer[i + outOffset] = (byte) (inBuffer[i + inOffset] ^ key[cleInd]);
+            cleInd = (cleInd + 1) % key.length;
+        }
+    }
 }

Modified: trunk/src/de/berlios/jmds/server/ServerInter.java
===================================================================
--- trunk/src/de/berlios/jmds/server/ServerInter.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/server/ServerInter.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -7,26 +7,17 @@
 package de.berlios.jmds.server;
 
 import org.omg.IOP.ServiceContext;
-import org.omg.PortableInterceptor.AdapterManagerIdHelper;
-import org.omg.PortableInterceptor.AdapterNameHelper;
 import org.omg.PortableInterceptor.ForwardRequest;
 import org.omg.PortableInterceptor.ServerRequestInfo;
 import org.omg.PortableInterceptor.ServerRequestInterceptor;
-import org.omg.PortableServer.AdapterActivator;
-import org.omg.PortableServer.AdapterActivatorOperations;
 
-import com.sun.corba.se.impl.protocol.giopmsgheaders.TargetAddress;
-import com.sun.corba.se.impl.protocol.giopmsgheaders.TargetAddressHelper;
-import com.sun.org.apache.xalan.internal.xsltc.runtime.Parameter;
-
-
 /**
  * @author S&#233;bastien GUINCHARD
  */
 public class ServerInter extends org.omg.CORBA.LocalObject implements ServerRequestInterceptor
 {
 
-	private int					userID;
+	private int userID;
 	/**
 	 * Comment for &lt;code&gt;serialVersionUID&lt;/code&gt;
 	 */
@@ -41,11 +32,17 @@
 	 */
 	public void receive_request_service_contexts (ServerRequestInfo ri) throws ForwardRequest
 	{
-		System.out.println (&quot;ServerInter.receive request_SC: &quot; + ri.operation());
-		ServiceContext sc = ri.get_request_service_context (0);
-		SCManager scManager = SCManager.getInstance ();
-		userID = scManager.decode (sc.context_data);
-		System.out.println (userID);
+		System.out.println (&quot;ServerInter.receive_request_SC request: &quot; + ri.request_id());
+		ServiceContext sc = ri.get_request_service_context(0);
+		byte[] scDecode = SCManager.getInstance().decode (sc.context_data);
+        
+        System.out.println(&quot;Target= &quot;+ ri.orb_id());
+		System.out.println (scDecode);
+        
+        if (!RightsManager.getInstance ().canUse (userID + &quot;&quot; , ri.orb_id() , ri.operation ()))
+        {
+            throw new SecurityException(&quot;User can not access to this object&quot;); 
+        }
 	}
 
 	/**
@@ -53,12 +50,7 @@
 	 */
 	public void receive_request (ServerRequestInfo ri) throws ForwardRequest
 	{
-		System.out.println (&quot;ServerInter.receive request: &quot; + new String (ri.object_id()));
-		System.out.println (&quot;####&quot; + ri.target_most_derived_interface() + &quot;####&quot;);
-		if (!RightsManager.getInstance ().canUse (userID + &quot;&quot; , new String (ri.object_id ()) , ri.operation ()))
-		{
-			//throw new SecurityException(&quot;User can not access to this object&quot;); 
-		}
+		System.out.println (&quot;ServerInter.receive request: &quot; + ri.request_id());
 	}
 
 	/**
@@ -66,13 +58,15 @@
 	 */
 	public void send_reply (ServerRequestInfo ri)
 	{
-		ServiceContext sc = ri.get_request_service_context (0);
-		SCManager scManager = SCManager.getInstance ();
+        System.out.println(&quot;ServerInter.send_reply request: &quot; + ri.request_id());
+        int id = ri.request_id();
+        byte[] tabId = Integer.toString(id).getBytes();
+        
+		byte [] scData = SCManager.getInstance().code(tabId);
+        ServiceContext sc = new ServiceContext ();
+        sc.context_data = scData;
 
-		byte [] tabByteSC = new Integer (ri.request_id ()).toString ().getBytes ();
-		//byte [] tabByteSC = scManager.code (tabId);
-		ri.add_reply_service_context (sc , true);
-		System.out.println (&quot;ServerInter.send_reply: &quot; + tabByteSC);
+		ri.add_reply_service_context(sc , true);
 	}
 
 	/**
@@ -80,7 +74,7 @@
 	 */
 	public void send_exception (ServerRequestInfo ri) throws ForwardRequest
 	{
-		System.out.println (&quot;ServerInter.send_exception: &quot; + ri.operation ());
+		System.out.println (&quot;ServerInter.send_exception: &quot; + ri.operation());
 	}
 
 	/**
@@ -88,7 +82,7 @@
 	 */
 	public void send_other (ServerRequestInfo ri) throws ForwardRequest
 	{
-		System.out.println (&quot;ServerInter.send_other: &quot; + ri.operation ());
+		System.out.println (&quot;ServerInter.send_other: &quot; + ri.operation());
 
 	}
 
@@ -97,7 +91,7 @@
 	 */
 	public String name ()
 	{
-		return &quot;Mon Intercepteur Serveur&quot;;
+		return &quot;JMDS Intercepteur Serveur&quot;;
 	}
 
 	/**
@@ -105,5 +99,6 @@
 	 */
 	public void destroy ()
 	{
-	}
+        System.out.println(&quot;Server Security Interceptor killed !!&quot;);   
+    }
 }

Modified: trunk/src/de/berlios/jmds/server/UserManagerAppletClient.java
===================================================================
--- trunk/src/de/berlios/jmds/server/UserManagerAppletClient.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/server/UserManagerAppletClient.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -18,8 +18,7 @@
 
     private final static byte CLA_SECURITY = (byte) 0x69;
     private final static byte INS_SET_USER = (byte) 0x30;
-    private final static byte INS_SET_SERVERKEY_MOD = (byte) 0x44;
-    private final static byte INS_SET_SERVERKEY_EXP = (byte) 0x66;
+    private final static byte INS_SET_SERVERKEY = (byte) 0x50;
     
     // ----------------------------------------------------------//
     // ------------------- PUBLIC METHODS -----------------------//
@@ -32,29 +31,18 @@
      * @throws SecurityException 
      */
     public static void setUser(byte[] userId) throws SecurityException, slbException {
-        AppletManager.sendCardAPDU(CLA_SECURITY, INS_SET_USER, 0, 0, Convertor.byteArrayToIntArray(userId), 0);
+        AppletManager.sendCardAPDU(CLA_SECURITY, INS_SET_USER, 0, 0, Convertor.ByteArrayToIntArray(userId), 0);
     }
 
     /**
-     * @param userId
+     * @param key
      * 
      * @return
      * @throws slbException 
      * @throws SecurityException 
      */
-    public static void setServerKeyModulus(byte[] mod) throws SecurityException, slbException {
-        AppletManager.sendCardAPDU(CLA_SECURITY, INS_SET_SERVERKEY_MOD, 0, 0, Convertor.byteArrayToIntArray(mod), 0);
+    public static void setServerKey(byte[] key) throws SecurityException, slbException {
+        AppletManager.sendCardAPDU(CLA_SECURITY, INS_SET_SERVERKEY, 0, 0, Convertor.ByteArrayToIntArray(key), 0);
     }
-
-    /**
-     * @param mod
-     * 
-     * @return
-     * @throws slbException 
-     * @throws SecurityException 
-     */
-    public static void setServerKeyExponent(byte[] exp) throws SecurityException, slbException {
-        AppletManager.sendCardAPDU(CLA_SECURITY, INS_SET_SERVERKEY_EXP, 0, 0, Convertor.byteArrayToIntArray(exp), 0);
-    }
 }
 

Added: trunk/src/de/berlios/jmds/server/UserManagerAppletWithKeyClient.java
===================================================================
--- trunk/src/de/berlios/jmds/server/UserManagerAppletWithKeyClient.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/server/UserManagerAppletWithKeyClient.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -0,0 +1,59 @@
+/*
+ * Created on 1 mars 2005
+ * by J&#233;r&#244;me GUERS
+ * Copyright: GPL - UMLV(FR) - 2004/2005
+ */
+package de.berlios.jmds.server;
+
+import slb.iop.slbException;
+import de.berlios.jmds.common.AppletManager;
+import de.berlios.jmds.tools.Convertor;
+
+/**
+ * DOCME
+ * 
+ * @author J&#233;r&#244;me GUERS
+ */
+public class UserManagerAppletWithKeyClient {
+
+    private final static byte CLA_SECURITY = (byte) 0x69;
+    private final static byte INS_SET_USER = (byte) 0x30;
+    private final static byte INS_SET_SERVERKEY_MOD = (byte) 0x44;
+    private final static byte INS_SET_SERVERKEY_EXP = (byte) 0x66;
+    
+    // ----------------------------------------------------------//
+    // ------------------- PUBLIC METHODS -----------------------//
+    // ----------------------------------------------------------//
+    /**
+     * @param userId
+     * 
+     * @return
+     * @throws slbException 
+     * @throws SecurityException 
+     */
+    public static void setUser(byte[] userId) throws SecurityException, slbException {
+        AppletManager.sendCardAPDU(CLA_SECURITY, INS_SET_USER, 0, 0, Convertor.ByteArrayToIntArray(userId), 0);
+    }
+
+    /**
+     * @param userId
+     * 
+     * @return
+     * @throws slbException 
+     * @throws SecurityException 
+     */
+    public static void setServerKeyModulus(byte[] mod) throws SecurityException, slbException {
+        AppletManager.sendCardAPDU(CLA_SECURITY, INS_SET_SERVERKEY_MOD, 0, 0, Convertor.ByteArrayToIntArray(mod), 0);
+    }
+
+    /**
+     * @param mod
+     * 
+     * @return
+     * @throws slbException 
+     * @throws SecurityException 
+     */
+    public static void setServerKeyExponent(byte[] exp) throws SecurityException, slbException {
+        AppletManager.sendCardAPDU(CLA_SECURITY, INS_SET_SERVERKEY_EXP, 0, 0, Convertor.ByteArrayToIntArray(exp), 0);
+    }
+}

Modified: trunk/src/de/berlios/jmds/tools/Convertor.java
===================================================================
--- trunk/src/de/berlios/jmds/tools/Convertor.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/tools/Convertor.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -17,18 +17,68 @@
  * 
  */
 public class Convertor {
+    
+    private final static String ByteToHexString(byte[] byteArray) {
+        String strArray = new String();
+        strArray = &quot;&quot;;
+        for (int x=0; x &lt; byteArray.length; x++) {
+            int b = ((int)byteArray[x] &amp; 0x000000ff);
+            if (b &lt; 16) 
+                strArray = strArray + &quot;0&quot; + Integer.toHexString(b).toUpperCase();
+            else  
+                strArray = strArray + Integer.toHexString(b).toUpperCase();
+        }
+        return strArray;
+    }
 
+    private final static byte[] ShortToBytePair(short i)
+    {
+        byte[] retVal = new byte[2];
+        retVal[0] = (byte)((i &amp; 0xFFFF) &gt;&gt; 8);
+        retVal[1] = (byte)(i &amp; 0x00FF);
+        return retVal;
+    }
+    
     // ----------------------------------------------------------//
     // ------------------- PUBLIC METHODS -----------------------//
     // ----------------------------------------------------------//
+    /**
+     * @param requestId
+     * @return the table of int
+     */
+    public final static int[] ByteArrayToIntArray(byte[] byteArray) {
+        int[] tmp = new int[byteArray.length];
+        for (int i = 0; i &lt; byteArray.length; i++) {
+            tmp[i] = byteArray[i];
+        }
+        return tmp;
+    }
 
+    /** 
+     * DOCME 
+     * 
+     * @param code
+     * @return 
+     */
+    public final static String ByteArrayToSpacedHexString(byte[] byteArray) {
+        String strArray = &quot;&quot;;
+        String strHex = &quot;&quot;;
+        byte[] dataArray = new byte[1];
+        
+        for (int x=0; x &lt; byteArray.length; x++) {
+          dataArray[0] = byteArray[x];
+          strHex = ByteToHexString(dataArray);      
+          strArray = strArray + strHex + &quot; &quot;;
+        }
+        return strArray;    }
+    
     /**
      * DOCME
      * 
      * @param value
      * @return a table of int containing the stirng
      */
-    public final static int[] stringToIntArray(String value) {
+    public final static int[] HexStringToIntArray(String value) {
         int intKey[] = new int[(value.length() / 2)];
         int y = 0;
         String strInt;
@@ -44,50 +94,12 @@
                     System.out.println(&quot;stringToShortArray Failed &quot;);
                 }
             }
-
             y = y + 2;
         }
         return intKey;
     }
 
     /**
-     * @param context_data
-     * @return string of the byte table
-     */
-    public final static String byteToString(byte[] context_data) {
-        StringBuffer sb = new StringBuffer();
-        for (int i = 0; i &lt; context_data.length; i++) {
-            sb.append(context_data[i]);
-        }
-        return sb.toString();
-    }
-
-    /**
-     * @param code
-     * @return a table of byte corresponding to the argument code
-     */
-    public final static byte[] shortArrayToByteArray(short[] code) {
-        byte[] tmp = new byte[code.length];
-        for (int i = 0; i &lt; code.length; i++) {
-            Short s = new Short(code[i]);
-            tmp[i] = s.byteValue();
-        }
-        return tmp;
-    }
-
-    /**
-     * @param requestId
-     * @return the table of int
-     */
-    public final static int[] byteArrayToIntArray(byte[] byteArray) {
-        int[] tmp = new int[byteArray.length];
-        for (int i = 0; i &lt; byteArray.length; i++) {
-            tmp[i] = byteArray[i];
-        }
-        return tmp;
-    }
-
-    /**
      * Parse la chaine en couple de deux chiffre et les converti en tableau de
      * short
      * 
@@ -110,12 +122,24 @@
                     System.out.println(&quot;HexStringToShortArray Failed &quot;);
                 }
             }
-
             y = y + 2;
         }
         return shortKey;
     }
 
+    /**
+     * @param code
+     * @return a table of byte corresponding to the argument code
+     */
+    public final static byte[] ShortArrayToByteArray(short[] code) {
+        byte[] tmp = new byte[code.length];
+        for (int i = 0; i &lt; code.length; i++) {
+            Short s = new Short(code[i]);
+            tmp[i] = s.byteValue();
+        }
+        return tmp;
+    }
+
     /** 
      * DOCME
      *
@@ -131,55 +155,9 @@
         for (int x=0; x &lt; shortArray.length; x++) {
           dataArray = ShortToBytePair(shortArray[x]);
           dataArray2[0] = dataArray[1];
-          strHex = byteToHexString(dataArray2);      
+          strHex = ByteToHexString(dataArray2);      
           strArray = strArray + strHex + &quot; &quot;;
         }
         return strArray;
     }
-    
-    public static byte[] ShortToBytePair(short i)
-    {
-        byte[] retVal = new byte[2];
-        retVal[0] = (byte)((i &amp; 0xFFFF) &gt;&gt; 8);
-        retVal[1] = (byte)(i &amp; 0x00FF);
-        return retVal;
-    }
-
-    /** 
-     * DOCME 
-     * 
-     * @param code
-     * @return 
-     */
-    public static String ByteArrayToSpacedHexString(byte[] byteArray) {
-        String strArray = &quot;&quot;;
-        String strHex = &quot;&quot;;
-        byte[] dataArray = new byte[1];
-        
-        for (int x=0; x &lt; byteArray.length; x++) {
-          dataArray[0] = byteArray[x];
-          strHex = byteToHexString(dataArray);      
-          strArray = strArray + strHex + &quot; &quot;;
-        }
-        return strArray;    }
-
-    /** 
-     * DOCME 
-     *
-     * @param dataArray
-     * @return 
-     */
-    private static String byteToHexString(byte[] byteArray) {
-        String strArray = new String();
-        strArray = &quot;&quot;;
-
-        for (int x=0; x &lt; byteArray.length; x++) {
-            int b = ((int)byteArray[x] &amp; 0x000000ff);
-            if (b &lt; 16) 
-                strArray = strArray + &quot;0&quot; + Integer.toHexString(b).toUpperCase();
-            else  
-                strArray = strArray + Integer.toHexString(b).toUpperCase();
-        }
-        return strArray;
-    }
 }

Modified: trunk/src/de/berlios/jmds/tools/RightsConfiguration.java
===================================================================
--- trunk/src/de/berlios/jmds/tools/RightsConfiguration.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/de/berlios/jmds/tools/RightsConfiguration.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -78,7 +78,6 @@
 	public boolean checkFonctionGroupAccess(String szGroup, String szIOR, String szFonction)
 	{
 		System.out.println(&quot;Recherche des groups ayant acces&quot;);
-		int i = 0;
 		int iIOR = -1;
 		int iFonction = -1;
 		
@@ -118,12 +117,11 @@
 			
 		if (iFonction !=- 1) 	// si la fonction existe
 			return false ;
-		else					// si la fonction n existe pas on l ajoute
-		{
-			int iAddFonction = countFonction(iIOR)+1;
-			rightsConfig.addProperty(&quot;ior(&quot;+ iIOR+ &quot;).fonction(&quot;+ iAddFonction+ &quot;)[@id]&quot;, szFonction);
-		}
 		
+        // si la fonction n existe pas on l ajoute
+		int iAddFonction = countFonction(iIOR)+1;
+		rightsConfig.addProperty(&quot;ior(&quot;+ iIOR+ &quot;).fonction(&quot;+ iAddFonction+ &quot;)[@id]&quot;, szFonction);
+		
 		return true;
 	}
 	
@@ -137,13 +135,11 @@
 		
 		if (iIOR !=-1) // Si l'objet existe dans le fichier de conf
 			return false ;
-		else // si l'objet n'existe pas on l'ajoute
-		{
-			int iAddIOR = countIOR()+1;
-			rightsConfig.addProperty(&quot;ior(&quot;+ iAddIOR +&quot;)[@id]&quot;, szIOR);
-			
-		}
-		return true;
+		// si l'objet n'existe pas on l'ajoute
+		int iAddIOR = countIOR()+1;
+		rightsConfig.addProperty(&quot;ior(&quot;+ iAddIOR +&quot;)[@id]&quot;, szIOR);
+
+        return true;
 	}
 	
 	/**

Modified: trunk/src/fr/umlv/ir3/corba/forum/ForumImpl.java
===================================================================
--- trunk/src/fr/umlv/ir3/corba/forum/ForumImpl.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/fr/umlv/ir3/corba/forum/ForumImpl.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -19,10 +19,10 @@
 	 * @param theme
 	 * @param moderator
 	 */
-	public ForumImpl(String theme, String moderator)
+	public ForumImpl(String t, String m)
 	{
-		this.theme = theme;
-		this.moderator = moderator;
+		this.theme = t;
+		this.moderator = m;
 		discussion = new ConcurrentHashMap();
 	}
 	
@@ -78,9 +78,9 @@
 	 /**
 	 * @see fr.umlv.ir3.corba.forum.ForumOperations#getInfo(org.omg.CORBA.StringHolder, org.omg.CORBA.StringHolder, org.omg.CORBA.IntHolder)
 	 */
-	public void getInfo (StringHolder theme, StringHolder moderator, IntHolder size) {
-	 	theme.value = this.theme;
-	 	moderator.value = this.moderator;
+	public void getInfo (StringHolder t, StringHolder m, IntHolder size) {
+	 	t.value = this.theme;
+	 	m.value = this.moderator;
 	 	size.value = discussion.size();
 	 }
 }

Modified: trunk/src/fr/umlv/ir3/corba/forum/SlimForumClient.java
===================================================================
--- trunk/src/fr/umlv/ir3/corba/forum/SlimForumClient.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/fr/umlv/ir3/corba/forum/SlimForumClient.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -3,8 +3,6 @@
  */
 package fr.umlv.ir3.corba.forum;
 
-import java.io.BufferedReader;
-import java.io.InputStreamReader;
 import java.util.Date;
 
 import org.omg.CORBA.Any;
@@ -33,8 +31,6 @@
         
         ORB orb = ORB.init(args, props);
 
-        BufferedReader in = new BufferedReader(new InputStreamReader(System.in));
-
         // Cr&#233;ation du service d'annuaire
         Object ns = orb.resolve_initial_references(&quot;NameService&quot;);
         NamingContextExt nc = NamingContextExtHelper.narrow(ns);
@@ -58,6 +54,5 @@
         } catch (Reject e) {
             System.out.println(&quot;Message non ajout&#233; pour cette raison:\n&quot; + e.message);
         }
-        
     }
 }

Modified: trunk/src/security.xml
===================================================================
--- trunk/src/security.xml	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/src/security.xml	2005-03-04 13:08:48 UTC (rev 53)
@@ -3,8 +3,8 @@
 &lt;jmds&gt;
 	&lt;server key=&quot;0123456789&quot;/&gt;
    &lt;clients&gt;
-      &lt;client id=&quot;1&quot; key=&quot;1111111111&quot; group=&quot;grp_1&quot;/&gt;
-      &lt;client id=&quot;2&quot; key=&quot;2222222222&quot; group=&quot;grp_2&quot;/&gt;
-      &lt;client id=&quot;3&quot; key=&quot;3333333333&quot; group=&quot;grp_1&quot;/&gt;
+      &lt;client id=&quot;jmds1&quot; key=&quot;1111111111&quot; group=&quot;grp_1&quot;/&gt;
+      &lt;client id=&quot;jmds2&quot; key=&quot;2222222222&quot; group=&quot;grp_2&quot;/&gt;
+      &lt;client id=&quot;jmds3&quot; key=&quot;3333333333&quot; group=&quot;grp_1&quot;/&gt;
    &lt;/clients &gt;
 &lt;/jmds&gt;

Modified: trunk/test/de/berlios/jmds/clients/TestSCApplet.java
===================================================================
--- trunk/test/de/berlios/jmds/clients/TestSCApplet.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/test/de/berlios/jmds/clients/TestSCApplet.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -9,60 +9,32 @@
  */
 package de.berlios.jmds.clients;
 
-import java.security.InvalidKeyException;
-import java.security.Key;
-import java.security.KeyPair;
-import java.security.KeyPairGenerator;
-import java.security.NoSuchAlgorithmException;
-import java.security.NoSuchProviderException;
-import java.security.interfaces.RSAPublicKey;
-
-import javax.crypto.BadPaddingException;
-import javax.crypto.Cipher;
-import javax.crypto.IllegalBlockSizeException;
-import javax.crypto.NoSuchPaddingException;
-import javax.crypto.ShortBufferException;
-
-
 import slb.iop.slbException;
 import de.berlios.jmds.client.SCAppletClient;
+import de.berlios.jmds.server.SCManager;
 import de.berlios.jmds.server.UserManagerAppletClient;
-import de.berlios.jmds.tools.Convertor;
 
 /**
  * DOCME
  * @author J&#233;r&#244;me GUERS
  * 
  */
-public class TestSCApllet{
+public class TestSCApplet{
 
-    public static void main(String[] args) throws NoSuchAlgorithmException, SecurityException, slbException, NoSuchPaddingException, InvalidKeyException, ShortBufferException, IllegalBlockSizeException, BadPaddingException, NoSuchProviderException {
-        KeyPair keyPair = KeyPairGenerator.getInstance(&quot;RSA&quot;).generateKeyPair();
+    public static void main(String[] args) throws SecurityException, slbException
+    {
+        UserManagerAppletClient.setUser(&quot;jmds1&quot;.getBytes());
+        UserManagerAppletClient.setServerKey(&quot;0123456789&quot;.getBytes());        
         
-        RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();
-        Key privateKey = keyPair.getPrivate();
+        byte[] code = &quot;test&quot;.getBytes();
         
-        UserManagerAppletClient.setUser(&quot;jmds&quot;.getBytes());
-        UserManagerAppletClient.setServerKeyModulus(publicKey.getModulus().toByteArray());
-        UserManagerAppletClient.setServerKeyExponent(publicKey.getPublicExponent().toByteArray());
+        System.out.println(&quot;Origine: &quot; + new String(code));
+        code = SCAppletClient.code(code);
         
-        byte[] code = {(short)0x55, (short)0x55,(short)0x55,(short)0x55,(short)0x55};
-        
-        try {
-            code = SCAppletClient.code(code);
-            
-            System.out.println(Convertor.ByteArrayToSpacedHexString(code));
-            
-            Cipher cipher = Cipher.getInstance(&quot;RSA/ECB/PKCS1Padding&quot;, &quot;BC&quot;);
-            cipher.init(Cipher.DECRYPT_MODE, privateKey);
-            cipher.doFinal(code, (short)0, (short) code.length, code, (short)0);
-
-            System.out.println(Convertor.ByteArrayToSpacedHexString(code));
-        } catch (SecurityException e) {
-            e.printStackTrace();
-        } catch (slbException e) {
-            e.printStackTrace();
-        } 
+        System.out.println(&quot;Cod&#233;e: &quot; + new String(code));
+        code = SCManager.getInstance().decode(code);
+        System.out.println(&quot;D&#233;cod&#233;e: &quot; + new String(code));
+        System.out.println(&quot;Reste &#224; parser le userID et le requestID pour v&#233;rifier&quot;);
         System.exit(0);
     }
 }

Added: trunk/test/de/berlios/jmds/clients/TestSCAppletWithKey.java
===================================================================
--- trunk/test/de/berlios/jmds/clients/TestSCAppletWithKey.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/test/de/berlios/jmds/clients/TestSCAppletWithKey.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -0,0 +1,67 @@
+/* 
+ * File    : SCManager.java
+ * Created : 18 f&#233;vr. 2005
+ * 
+ * =======================================
+ * JMDS PROJECT (&quot;<A HREF="http://jmds.berlios.de">http://jmds.berlios.de</A>&quot;)
+ * =======================================
+ *
+ */
+package de.berlios.jmds.clients;
+
+import java.security.InvalidKeyException;
+import java.security.Key;
+import java.security.KeyPair;
+import java.security.KeyPairGenerator;
+import java.security.NoSuchAlgorithmException;
+import java.security.NoSuchProviderException;
+import java.security.interfaces.RSAPublicKey;
+
+import javax.crypto.BadPaddingException;
+import javax.crypto.Cipher;
+import javax.crypto.IllegalBlockSizeException;
+import javax.crypto.NoSuchPaddingException;
+import javax.crypto.ShortBufferException;
+
+import slb.iop.slbException;
+import de.berlios.jmds.client.SCAppletClient;
+import de.berlios.jmds.server.UserManagerAppletWithKeyClient;
+import de.berlios.jmds.tools.Convertor;
+
+/**
+ * DOCME
+ * @author J&#233;r&#244;me GUERS
+ * 
+ */
+public class TestSCAppletWithKey{
+
+    public static void main(String[] args) throws NoSuchAlgorithmException, SecurityException, slbException, NoSuchPaddingException, InvalidKeyException, ShortBufferException, IllegalBlockSizeException, BadPaddingException, NoSuchProviderException {
+        KeyPair keyPair = KeyPairGenerator.getInstance(&quot;RSA&quot;).generateKeyPair();
+        
+        RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();
+        Key privateKey = keyPair.getPrivate();
+        
+        UserManagerAppletWithKeyClient.setUser(&quot;jmds&quot;.getBytes());
+        UserManagerAppletWithKeyClient.setServerKeyModulus(publicKey.getModulus().toByteArray());
+        UserManagerAppletWithKeyClient.setServerKeyExponent(publicKey.getPublicExponent().toByteArray());
+        
+        byte[] code = {(short)0x55, (short)0x55,(short)0x55,(short)0x55,(short)0x55};
+        
+        try {
+            code = SCAppletClient.code(code);
+            
+            System.out.println(Convertor.ByteArrayToSpacedHexString(code));
+            
+            Cipher cipher = Cipher.getInstance(&quot;RSA/ECB/PKCS1Padding&quot;, &quot;BC&quot;);
+            cipher.init(Cipher.DECRYPT_MODE, privateKey);
+            cipher.doFinal(code, (short)0, (short) code.length, code, (short)0);
+
+            System.out.println(Convertor.ByteArrayToSpacedHexString(code));
+        } catch (SecurityException e) {
+            e.printStackTrace();
+        } catch (slbException e) {
+            e.printStackTrace();
+        } 
+        System.exit(0);
+    }
+}

Modified: trunk/test/de/berlios/jmds/tools/SecurityConfigurationTest.java
===================================================================
--- trunk/test/de/berlios/jmds/tools/SecurityConfigurationTest.java	2005-03-04 09:35:32 UTC (rev 52)
+++ trunk/test/de/berlios/jmds/tools/SecurityConfigurationTest.java	2005-03-04 13:08:48 UTC (rev 53)
@@ -21,7 +21,7 @@
 		SecurityConfiguration securityConf = SecurityConfiguration.getInstance();
 		
 		System.out.println(&quot;Key server : &quot; + securityConf.getServerKey());
-		System.out.println(&quot;Key client 2 : &quot; + securityConf.getClientKey(&quot;2&quot;));
-		System.out.println(&quot;Key groupe client 1 : &quot; + securityConf.getclientGroup(&quot;1&quot;));
+		System.out.println(&quot;Key client 2 : &quot; + securityConf.getClientKey(&quot;jmds2&quot;));
+		System.out.println(&quot;Key groupe client 1 : &quot; + securityConf.getclientGroup(&quot;jmds1&quot;));
 	}
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000066.html">[Jmds-svn] r52 - trunk/test/de/berlios/jmds/clients
</A></li>
	<LI>Next message: <A HREF="000068.html">[Jmds-svn] r54 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#67">[ date ]</a>
              <a href="thread.html#67">[ thread ]</a>
              <a href="subject.html#67">[ subject ]</a>
              <a href="author.html#67">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/jmds-svn">More information about the Jmds-svn
mailing list</a><br>
</body></html>
