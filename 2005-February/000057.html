<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Jmds-svn] r44 - members/jguers/TestCard/applets/de/berlios/jmds/test/javacard trunk trunk/applet/de/berlios/jmds/applet/javacard trunk/generator trunk/lib trunk/src/de/berlios/jmds/applet trunk/src/de/berlios/jmds/client trunk/src/de/berlios/jmds/tools trunk/test/de/berlios/jmds/applet trunk/test/de/berlios/jmds/clients
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/jmds-svn/2005-February/index.html" >
   <LINK REL="made" HREF="mailto:jmds-svn%40lists.berlios.de?Subject=Re%3A%20%5BJmds-svn%5D%20r44%20-%20members/jguers/TestCard/applets/de/berlios/jmds/test/javacard%20trunk%20trunk/applet/de/berlios/jmds/applet/javacard%20trunk/generator%20trunk/lib%20trunk/src/de/berlios/jmds/applet%20trunk/src/de/berlios/jmds/client%20trunk/src/de/berlios/jmds/tools%20trunk/test/de/berlios/jmds/applet%20trunk/test/de/berlios/jmds/clients&In-Reply-To=%3C200502262255.j1QMtHxG030247%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000056.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Jmds-svn] r44 - members/jguers/TestCard/applets/de/berlios/jmds/test/javacard trunk trunk/applet/de/berlios/jmds/applet/javacard trunk/generator trunk/lib trunk/src/de/berlios/jmds/applet trunk/src/de/berlios/jmds/client trunk/src/de/berlios/jmds/tools trunk/test/de/berlios/jmds/applet trunk/test/de/berlios/jmds/clients</H1>
    <B>J&#233;r&#244;me GUERS at BerliOS</B> 
    <A HREF="mailto:jmds-svn%40lists.berlios.de?Subject=Re%3A%20%5BJmds-svn%5D%20r44%20-%20members/jguers/TestCard/applets/de/berlios/jmds/test/javacard%20trunk%20trunk/applet/de/berlios/jmds/applet/javacard%20trunk/generator%20trunk/lib%20trunk/src/de/berlios/jmds/applet%20trunk/src/de/berlios/jmds/client%20trunk/src/de/berlios/jmds/tools%20trunk/test/de/berlios/jmds/applet%20trunk/test/de/berlios/jmds/clients&In-Reply-To=%3C200502262255.j1QMtHxG030247%40sheep.berlios.de%3E"
       TITLE="[Jmds-svn] r44 - members/jguers/TestCard/applets/de/berlios/jmds/test/javacard trunk trunk/applet/de/berlios/jmds/applet/javacard trunk/generator trunk/lib trunk/src/de/berlios/jmds/applet trunk/src/de/berlios/jmds/client trunk/src/de/berlios/jmds/tools trunk/test/de/berlios/jmds/applet trunk/test/de/berlios/jmds/clients">jguers at sheep.berlios.de
       </A><BR>
    <I>Sat Feb 26 23:55:17 CET 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000056.html">[Jmds-svn] r43 - in trunk: . src/de/berlios/jmds/client src/de/berlios/jmds/server src/de/berlios/jmds/tools
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57">[ date ]</a>
              <a href="thread.html#57">[ thread ]</a>
              <a href="subject.html#57">[ subject ]</a>
              <a href="author.html#57">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jguers
Date: 2005-02-26 23:55:15 +0100 (Sat, 26 Feb 2005)
New Revision: 44

Added:
   trunk/lib/jc_api_212.jar
   trunk/src/de/berlios/jmds/applet/SCAppletWithKey.java
   trunk/test/de/berlios/jmds/clients/TestSCApllet.java
Removed:
   trunk/test/de/berlios/jmds/applet/SCAppletWithKey.java
Modified:
   members/jguers/TestCard/applets/de/berlios/jmds/test/javacard/test.jar
   members/jguers/TestCard/applets/de/berlios/jmds/test/javacard/test.jca
   trunk/.classpath
   trunk/applet/de/berlios/jmds/applet/javacard/applet.ijc
   trunk/applet/de/berlios/jmds/applet/javacard/applet.jar
   trunk/applet/de/berlios/jmds/applet/javacard/applet.jca
   trunk/generator/SecurityApplet.pmf
   trunk/src/de/berlios/jmds/applet/SCApplet.java
   trunk/src/de/berlios/jmds/client/ClientInter.java
   trunk/src/de/berlios/jmds/client/SCAppletClient.java
   trunk/src/de/berlios/jmds/tools/Convertor.java
Log:
Victoire : lib pour faire du cryptage trouvee
pb ac applet corrige (simple double declaration de variable et ecriture dans deux differentes ! Je suis un boulet !)
Remise en forme de SCAppletClient.java + modification du listerner de carte : on recherche sur tous les lecteurs la carte qui poss?\195?\168de notre applet

C'est en bonne voie, mais j'ai un nouveau pb ce soir : mon code ne veux plus s'instancier.. Ce doit etre une connerie. Je regarderais a tete reposee plus tard

Pour memoire : pour la recherche des objets connus, il nous faut lister les obj connus du service de nommage et on limite les objets securises aux objets enregistres aupres du service de nommage (Matt et/ou Denis : on en reparlera qd vous lirez ce commit et si vou voulez vous repenchez sur le pb)

Modified: members/jguers/TestCard/applets/de/berlios/jmds/test/javacard/test.jar
===================================================================
(Binary files differ)

Modified: members/jguers/TestCard/applets/de/berlios/jmds/test/javacard/test.jca
===================================================================
--- members/jguers/TestCard/applets/de/berlios/jmds/test/javacard/test.jca	2005-02-25 20:55:20 UTC (rev 43)
+++ members/jguers/TestCard/applets/de/berlios/jmds/test/javacard/test.jca	2005-02-26 22:55:15 UTC (rev 44)
@@ -1,5 +1,5 @@
 // converted by version 1.3
-// on Fri Feb 25 00:46:14 CET 2005
+// on Sat Feb 26 23:17:38 CET 2005
 
 .package de/berlios/jmds/test {
 	.aid 0x11:0x22:0x33:0x44:0x55:0x66;

Modified: trunk/.classpath
===================================================================
--- trunk/.classpath	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/.classpath	2005-02-26 22:55:15 UTC (rev 44)
@@ -10,5 +10,6 @@
 	&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib/commons-configuration-1.1RC1.jar&quot;/&gt;
 	&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib/commons-logging-1.0.4.jar&quot;/&gt;
 	&lt;classpathentry kind=&quot;con&quot; path=&quot;org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/jre1.5.0&quot;/&gt;
+	&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib/jc_api_212.jar&quot;/&gt;
 	&lt;classpathentry kind=&quot;output&quot; path=&quot;classes&quot;/&gt;
 &lt;/classpath&gt;

Modified: trunk/applet/de/berlios/jmds/applet/javacard/applet.ijc
===================================================================
(Binary files differ)

Modified: trunk/applet/de/berlios/jmds/applet/javacard/applet.jar
===================================================================
(Binary files differ)

Modified: trunk/applet/de/berlios/jmds/applet/javacard/applet.jca
===================================================================
--- trunk/applet/de/berlios/jmds/applet/javacard/applet.jca	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/applet/de/berlios/jmds/applet/javacard/applet.jca	2005-02-26 22:55:15 UTC (rev 44)
@@ -1,5 +1,5 @@
 // converted by version 1.3
-// on Fri Feb 25 01:23:51 CET 2005
+// on Sat Feb 26 23:44:50 CET 2005
 
 .package de/berlios/jmds/applet {
 	.aid 0x11:0x22:0x33:0x44:0x55:0x66;
@@ -8,10 +8,11 @@
 	.imports {
 		0xA0:0x0:0x0:0x0:0x62:0x1:0x1 1.0;		//javacard/framework
 		0xA0:0x0:0x0:0x0:0x62:0x1:0x2 1.1;		//javacard/security
+		0xA0:0x0:0x0:0x0:0x62:0x2:0x1 1.1;		//javacardx/crypto
 	}
 
 	.applet {
-		0x11:0x22:0x33:0x44:0x55:0x66:0x77 SCApplet;
+		0x11:0x22:0x33:0x44:0x55:0x66:0x77 SCAppletWithKey;
 	}
 
 	.constantPool {
@@ -24,7 +25,7 @@
 		// 3
 		instanceFieldRef byte SCApplet/key;
 		// 4
-		instanceFieldRef byte[] SCAppletWithKey/buffer;
+		instanceFieldRef byte[] SCAppletWithKey/privateCode;
 		// 5
 		instanceFieldRef byte[] SCAppletWithKey/code;
 		// 6
@@ -36,59 +37,67 @@
 		// 9
 		instanceFieldRef 1.8 SCAppletWithKey/sessionKey;
 		// 10
-		staticMethodRef SCApplet/encode(Ljavacard/framework/APDU;)V;
-			.descriptor	Ljavacard/framework/APDU;	0.10;
-
+		instanceFieldRef 2.1 SCAppletWithKey/cipher;
 		// 11
-		staticMethodRef SCApplet/getEncode(Ljavacard/framework/APDU;)V;
-			.descriptor	Ljavacard/framework/APDU;	0.10;
-
+		instanceFieldRef byte[] SCAppletWithKey/buffer;
 		// 12
-		staticMethodRef 0.7.1(S)V;		// javacard/framework/ISOException.throwIt(S)V
-		// 13
 		virtualMethodRef 0.10.6()S;		// javacard/framework/APDU.setIncomingAndReceive()S
-		// 14
+		// 13
 		virtualMethodRef 1.14.1([BSS)V;		// javacard/security/RandomData.generateData([BSS)V
-		// 15
+		// 14
 		virtualMethodRef 0.10.7()S;		// javacard/framework/APDU.setOutgoing()S
-		// 16
+		// 15
 		virtualMethodRef 0.10.9(S)V;		// javacard/framework/APDU.setOutgoingLength(S)V
-		// 17
+		// 16
 		virtualMethodRef 0.10.5([BSS)V;		// javacard/framework/APDU.sendBytesLong([BSS)V
-		// 18
+		// 17
 		staticMethodRef 0.3.0()V;		// javacard/framework/Applet.&lt;init&gt;()V
-		// 19
+		// 18
 		staticMethodRef 1.14.0(B)Ljavacard/security/RandomData;;		// javacard/security/RandomData.getInstance(B)Ljavacard/security/RandomData;
 			.descriptor	Ljavacard/security/RandomData;	1.14;
 
-		// 20
+		// 19
 		virtualMethodRef 0.3.1()V;		// javacard/framework/Applet.register()V
-		// 21
+		// 20
 		staticMethodRef 1.13.0(BSZ)Ljavacard/security/Key;;		// javacard/security/KeyBuilder.buildKey(BSZ)Ljavacard/security/Key;
 			.descriptor	Ljavacard/security/Key;	1.0;
 
-		// 22
+		// 21
 		classRef 1.8;		// javacard/security/RSAPrivateKey
+		// 22
+		classRef SCApplet;
 		// 23
-		classRef SCAppletWithKey;
+		staticFieldRef byte[] SCAppletWithKey/rsaPrivateKey;
 		// 24
 		classRef 1.9;		// javacard/security/RSAPublicKey
 		// 25
-		staticMethodRef SCAppletWithKey/&lt;init&gt;()V;
+		staticMethodRef SCApplet/&lt;init&gt;()V;
 		// 26
 		virtualMethodRef 0.10.1()[B;		// javacard/framework/APDU.getBuffer()[B
 		// 27
-		classRef SCApplet;
+		staticMethodRef 2.1.0(BZ)Ljavacardx/crypto/Cipher;;		// javacardx/crypto/Cipher.getInstance(BZ)Ljavacardx/crypto/Cipher;
+			.descriptor	Ljavacardx/crypto/Cipher;	2.1;
+
 		// 28
-		staticMethodRef SCApplet/&lt;init&gt;()V;
-		// 29
-		staticMethodRef SCAppletWithKey/encode(Ljavacard/framework/APDU;)V;
+		staticMethodRef SCApplet/encode(Ljavacard/framework/APDU;)V;
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
+		// 29
+		classRef SCAppletWithKey;
 		// 30
-		staticMethodRef SCAppletWithKey/getEncode(Ljavacard/framework/APDU;)V;
+		staticMethodRef SCAppletWithKey/&lt;init&gt;()V;
+		// 31
+		staticMethodRef 0.7.1(S)V;		// javacard/framework/ISOException.throwIt(S)V
+		// 32
+		staticMethodRef SCAppletWithKey/encode(Ljavacard/framework/APDU;)V;
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
+		// 33
+		virtualMethodRef 2.1.3(Ljavacard/security/Key;B)V;		// javacardx/crypto/Cipher.init(Ljavacard/security/Key;B)V
+			.descriptor	Ljavacard/security/Key;	1.0;
+
+		// 34
+		virtualMethodRef 2.1.1([BSS[BS)S;		// javacardx/crypto/Cipher.doFinal([BSS[BS)S
 	}
 
 	.class public SCApplet 0 extends 0.3 {		// extends javacard/framework/Applet
@@ -126,7 +135,7 @@
 			.locals 0;
 
 				L0:	aload_0;
-					invokespecial 18;		// javacard/framework/Applet.&lt;init&gt;()V
+					invokespecial 17;		// javacard/framework/Applet.&lt;init&gt;()V
 					aload_0;
 					bspush 32;
 					newarray 11;
@@ -137,13 +146,13 @@
 					putfield_a 1;		// reference de/berlios/jmds/applet/SCApplet.code
 					aload_0;
 					sconst_2;
-					invokestatic 19;		// javacard/security/RandomData.getInstance(B)Ljavacard/security/RandomData;
+					invokestatic 18;		// javacard/security/RandomData.getInstance(B)Ljavacard/security/RandomData;
 					putfield_a 2;		// reference de/berlios/jmds/applet/SCApplet.randomer
 					aload_0;
 					sconst_0;
 					putfield_b 3;		// byte de/berlios/jmds/applet/SCApplet.key
 					aload_0;
-					invokevirtual 20;		// javacard/framework/Applet.register()V
+					invokevirtual 19;		// javacard/framework/Applet.register()V
 					return;
 		}
 
@@ -151,46 +160,42 @@
 			.stack 1;
 			.locals 0;
 
-				L0:	new 23;		// de/berlios/jmds/applet/SCAppletWithKey
-					invokespecial 25;		// de/berlios/jmds/applet/SCAppletWithKey.&lt;init&gt;()V
+				L0:	new 22;		// de/berlios/jmds/applet/SCApplet
+					invokespecial 25;		// de/berlios/jmds/applet/SCApplet.&lt;init&gt;()V
 					return;
 		}
 
 		.method public process(Ljavacard/framework/APDU;)V 7 {
 			.stack 2;
-			.locals 1;
+			.locals 0;
 
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-				L0:	aload_1;
+				L0:	aload_0;
+					aload_1;
 					invokevirtual 26;		// javacard/framework/APDU.getBuffer()[B
-					astore_2;
-					aload_2;
+					putfield_a 0;		// reference de/berlios/jmds/applet/SCApplet.buffer
+					getfield_a_this 0;		// reference de/berlios/jmds/applet/SCApplet.buffer
 					sconst_0;
 					baload;
 					bspush 105;
-					if_scmpne L8;
-				L1:	aload_2;
+					if_scmpne L6;
+				L1:	getfield_a_this 0;		// reference de/berlios/jmds/applet/SCApplet.buffer
 					sconst_1;
 					baload;
-					slookupswitch L7 5 16 L2 17 L3 48 L4 51 L5 119 L6;
+					slookupswitch L5 3 16 L2 48 L3 119 L4;
 				L2:	aload_0;
 					aload_1;
-					invokespecial 10;		// de/berlios/jmds/applet/SCApplet.encode(Ljavacard/framework/APDU;)V
-					goto L9;
-				L3:	aload_0;
-					aload_1;
-					invokespecial 11;		// de/berlios/jmds/applet/SCApplet.getEncode(Ljavacard/framework/APDU;)V
-					goto L9;
-				L4:	goto L9;
-				L5:	goto L9;
-				L6:	goto L9;
-				L7:	sspush 27904;
-					invokestatic 12;		// javacard/framework/ISOException.throwIt(S)V
-					goto L9;
-				L8:	sspush 28160;
-					invokestatic 12;		// javacard/framework/ISOException.throwIt(S)V
-				L9:	return;
+					invokespecial 28;		// de/berlios/jmds/applet/SCApplet.encode(Ljavacard/framework/APDU;)V
+					goto L7;
+				L3:	goto L7;
+				L4:	goto L7;
+				L5:	sspush 27904;
+					invokestatic 31;		// javacard/framework/ISOException.throwIt(S)V
+					goto L7;
+				L6:	sspush 28160;
+					invokestatic 31;		// javacard/framework/ISOException.throwIt(S)V
+				L7:	return;
 		}
 
 		.method private encode(Ljavacard/framework/APDU;)V {
@@ -200,13 +205,13 @@
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
 				L0:	aload_1;
-					invokevirtual 13;		// javacard/framework/APDU.setIncomingAndReceive()S
+					invokevirtual 12;		// javacard/framework/APDU.setIncomingAndReceive()S
 					sstore_2;
 					getfield_a_this 2;		// reference de/berlios/jmds/applet/SCApplet.randomer
 					getfield_a_this 1;		// reference de/berlios/jmds/applet/SCApplet.code
 					sconst_0;
 					bspush 32;
-					invokevirtual 14;		// javacard/security/RandomData.generateData([BSS)V
+					invokevirtual 13;		// javacard/security/RandomData.generateData([BSS)V
 					sconst_0;
 					sstore_3;
 					goto L2;
@@ -224,31 +229,22 @@
 				L2:	sload_3;
 					sload_2;
 					if_scmplt L1;
-				L3:	return;
-		}
-
-		.method private getEncode(Ljavacard/framework/APDU;)V {
-			.stack 4;
-			.locals 1;
-
-			.descriptor	Ljavacard/framework/APDU;	0.10;
-
-				L0:	aload_1;
-					invokevirtual 15;		// javacard/framework/APDU.setOutgoing()S
-					sstore_2;
-					sload_2;
+				L3:	aload_1;
+					invokevirtual 14;		// javacard/framework/APDU.setOutgoing()S
+					sstore_3;
+					sload_3;
 					bspush 32;
-					if_scmpge L2;
-				L1:	sspush 26368;
-					invokestatic 12;		// javacard/framework/ISOException.throwIt(S)V
-				L2:	aload_1;
+					if_scmpge L5;
+				L4:	sspush 26368;
+					invokestatic 31;		// javacard/framework/ISOException.throwIt(S)V
+				L5:	aload_1;
 					bspush 32;
-					invokevirtual 16;		// javacard/framework/APDU.setOutgoingLength(S)V
+					invokevirtual 15;		// javacard/framework/APDU.setOutgoingLength(S)V
 					aload_1;
 					getfield_a_this 1;		// reference de/berlios/jmds/applet/SCApplet.code
 					sconst_0;
 					bspush 32;
-					invokevirtual 17;		// javacard/framework/APDU.sendBytesLong([BSS)V
+					invokevirtual 16;		// javacard/framework/APDU.sendBytesLong([BSS)V
 					return;
 		}
 
@@ -258,17 +254,19 @@
 
 		.fields {
 			private byte[] buffer 0;		// [B
-			private byte[] code 1;		// [B
-			private 1.8 userKey 2;		// Ljavacard/security/RSAPrivateKey;
-			private 1.9 serverKey 3;		// Ljavacard/security/RSAPublicKey;
-			private 1.8 sessionKey 4;		// Ljavacard/security/RSAPrivateKey;
-			private short messLength 5;		// S
+			private byte[] privateCode 1;		// [B
+			private byte[] code 2;		// [B
+			private 1.8 userKey 3;		// Ljavacard/security/RSAPrivateKey;
+			private 1.9 serverKey 4;		// Ljavacard/security/RSAPublicKey;
+			private 1.8 sessionKey 5;		// Ljavacard/security/RSAPrivateKey;
+			private 2.1 cipher 6;		// Ljavacardx/crypto/Cipher;
+			private short messLength 7;		// S
 			private static final byte CLA_SECURITY = 105;		// B
 			private static final byte CODE = 16;		// B
-			private static final byte GET_CODE = 32;		// B
 			private static final byte DECODE = 48;		// B
-			private static final byte GET_DECODE = 64;		// B
 			private static final short BUFFER_LENGTH = 255;		// S
+			static byte[] rsaPrivateKey = {-62,1,5,-62,65,0,-59,-41,32,40,-6,-89,-111,85,35,-30,13,-28,40,124,101,-73,24,89,-39,13,-70,-25,-49,106,-15,-29,16,-61,126,72,13,-68,118,123,4,-122,-74,127,-51,108,-124,26,11,-122,-71,-106,-86,-125,104,99,60,77,67,-124,-72,109,72,-86,-60,-55,27,80,71,73,-62,65,0,-55,94,74,8,14,-36,-91,69,-112,28,82,-8,62,-80,107,-113,-49,-22,-88,-11,30,-83,-45,-126,82,48,67,4,-100,37,99,-121,55,32,100,63,22,-80,80,-52,56,6,27,-33,-26,120,-61,-103,-9,-60,63,-107,-127,-32,119,92,-93,120,-72,-100,-115,-101,70,93,-62,65,0,127,-34,23,54,-38,24,30,-17,-48,80,-67,44,87,-66,16,123,8,125,-58,-57,-11,118,-94,89,53,125,-22,-80,115,-26,81,-21,-45,7,-35,115,86,-117,118,70,63,-82,10,-71,-93,-29,13,113,-5,-2,85,2,-10,-74,77,-62,121,100,-3,40,-69,19,35,-78,-62,65,0,-93,-115,-93,-19,-100,-62,24,-72,-99,16,-115,81,88,82,-10,-73,-75,-18,-39,44,-85,-98,101,-17,-48,-122,89,-34,115,-80,87,-126,-67,36,23,-22,-46,70,-73,105,-123,-112,14,-123,83,58,6,62,-38,118,103,108,-84,107,-75,!
 23,-53,98,57,-118,-44,4,-70,-39,-62,65,0,68,3,3,-80,27,12,-19,9,68,-74,60,83,-70,32,-82,3,-95,-82,-39,40,9,23,-98,-61,122,108,-16,-123,-61,19,97,-67,78,-94,51,25,-105,-39,47,64,-6,127,29,-75,14,-53,-91,13,0,-63,24,-44,-81,76,24,36,-126,-42,8,76,96,11,-100,-59};		// [B
+			static byte[] rsaPublicKey = {-63,1,5,-64,-127,0,-101,-98,-58,116,101,90,-68,-70,-58,-80,93,60,36,60,-112,89,125,91,109,3,123,-83,-102,-76,88,-2,-128,34,-20,-16,-85,-124,-7,7,-124,-111,-30,8,-90,-101,-19,-41,69,-55,-35,-65,-8,122,-117,-31,23,-51,61,-45,111,-78,89,12,14,71,11,-114,-125,-59,15,-81,-40,33,12,-47,11,-76,36,-115,102,-84,-109,-93,-28,97,-17,38,80,28,48,-19,115,-15,-110,-40,44,-58,56,-44,109,-127,72,43,-52,66,-8,96,97,-83,-115,127,-115,109,-121,-65,125,28,97,43,-64,66,71,-37,-35,-55,63,7,35,-31,61,-38,-37,-123,-64,4,0,1,0,1};		// [B
 		}
 
 		.publicMethodTable 7 {
@@ -290,11 +288,11 @@
 			.locals 0;
 
 				L0:	aload_0;
-					invokespecial 18;		// javacard/framework/Applet.&lt;init&gt;()V
+					invokespecial 17;		// javacard/framework/Applet.&lt;init&gt;()V
 					aload_0;
 					sspush 255;
 					newarray 11;
-					putfield_a 4;		// reference de/berlios/jmds/applet/SCAppletWithKey.buffer
+					putfield_a 4;		// reference de/berlios/jmds/applet/SCAppletWithKey.privateCode
 					aload_0;
 					sspush 255;
 					newarray 11;
@@ -306,25 +304,36 @@
 					sconst_5;
 					sspush 512;
 					sconst_1;
-					invokestatic 21;		// javacard/security/KeyBuilder.buildKey(BSZ)Ljavacard/security/Key;
-					checkcast 0 22;		// T_CLASSORINTERFACE javacard/security/RSAPrivateKey
+					invokestatic 20;		// javacard/security/KeyBuilder.buildKey(BSZ)Ljavacard/security/Key;
+					checkcast 0 21;		// T_CLASSORINTERFACE javacard/security/RSAPrivateKey
 					putfield_a 7;		// reference de/berlios/jmds/applet/SCAppletWithKey.userKey
+					getfield_a_this 7;		// reference de/berlios/jmds/applet/SCAppletWithKey.userKey
+					getstatic_a 23;		// reference de/berlios/jmds/applet/SCAppletWithKey.rsaPrivateKey
+					sconst_5;
+					bspush 12;
+					invokeinterface 4 21 6;		// javacard/security/RSAPrivateKey
+					getfield_a_this 7;		// reference de/berlios/jmds/applet/SCAppletWithKey.userKey
+					getstatic_a 23;		// reference de/berlios/jmds/applet/SCAppletWithKey.rsaPrivateKey
+					bspush 127;
+					bspush 6;
+					invokeinterface 4 21 7;		// javacard/security/RSAPrivateKey
 					aload_0;
 					sconst_4;
 					sspush 512;
 					sconst_1;
-					invokestatic 21;		// javacard/security/KeyBuilder.buildKey(BSZ)Ljavacard/security/Key;
+					invokestatic 20;		// javacard/security/KeyBuilder.buildKey(BSZ)Ljavacard/security/Key;
 					checkcast 0 24;		// T_CLASSORINTERFACE javacard/security/RSAPublicKey
 					putfield_a 8;		// reference de/berlios/jmds/applet/SCAppletWithKey.serverKey
 					aload_0;
-					sconst_5;
-					sspush 512;
-					sconst_1;
-					invokestatic 21;		// javacard/security/KeyBuilder.buildKey(BSZ)Ljavacard/security/Key;
-					checkcast 0 22;		// T_CLASSORINTERFACE javacard/security/RSAPrivateKey
+					aconst_null;
 					putfield_a 9;		// reference de/berlios/jmds/applet/SCAppletWithKey.sessionKey
 					aload_0;
-					invokevirtual 20;		// javacard/framework/Applet.register()V
+					bspush 11;
+					sconst_0;
+					invokestatic 27;		// javacardx/crypto/Cipher.getInstance(BZ)Ljavacardx/crypto/Cipher;
+					putfield_a 10;		// reference de/berlios/jmds/applet/SCAppletWithKey.cipher
+					aload_0;
+					invokevirtual 19;		// javacard/framework/Applet.register()V
 					return;
 		}
 
@@ -332,91 +341,74 @@
 			.stack 1;
 			.locals 0;
 
-				L0:	new 27;		// de/berlios/jmds/applet/SCApplet
-					invokespecial 28;		// de/berlios/jmds/applet/SCApplet.&lt;init&gt;()V
+				L0:	new 29;		// de/berlios/jmds/applet/SCAppletWithKey
+					invokespecial 30;		// de/berlios/jmds/applet/SCAppletWithKey.&lt;init&gt;()V
 					return;
 		}
 
 		.method public process(Ljavacard/framework/APDU;)V 7 {
 			.stack 2;
-			.locals 1;
+			.locals 0;
 
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-				L0:	aload_1;
+				L0:	aload_0;
+					aload_1;
 					invokevirtual 26;		// javacard/framework/APDU.getBuffer()[B
-					astore_2;
-					aload_2;
+					putfield_a 11;		// reference de/berlios/jmds/applet/SCAppletWithKey.buffer
+					getfield_a_this 11;		// reference de/berlios/jmds/applet/SCAppletWithKey.buffer
 					sconst_0;
 					baload;
 					bspush 105;
-					if_scmpne L5;
-				L1:	aload_2;
+					if_scmpne L3;
+				L1:	getfield_a_this 11;		// reference de/berlios/jmds/applet/SCAppletWithKey.buffer
 					sconst_1;
 					baload;
-					slookupswitch L5 4 16 L2 32 L3 48 L4 64 L5;
+					slookupswitch L3 2 16 L2 48 L3;
 				L2:	aload_0;
 					aload_1;
-					invokespecial 29;		// de/berlios/jmds/applet/SCAppletWithKey.encode(Ljavacard/framework/APDU;)V
-					goto L5;
-				L3:	aload_0;
-					aload_1;
-					invokespecial 30;		// de/berlios/jmds/applet/SCAppletWithKey.getEncode(Ljavacard/framework/APDU;)V
-					goto L5;
-				L4:	goto L5;
-				L5:	return;
+					invokespecial 32;		// de/berlios/jmds/applet/SCAppletWithKey.encode(Ljavacard/framework/APDU;)V
+					goto L3;
+				L3:	return;
 		}
 
 		.method private encode(Ljavacard/framework/APDU;)V {
-			.stack 5;
-			.locals 2;
+			.stack 6;
+			.locals 3;
 
 			.descriptor	Ljavacard/framework/APDU;	0.10;
 
-				L0:	aload_0;
-					aload_1;
-					invokevirtual 13;		// javacard/framework/APDU.setIncomingAndReceive()S
-					putfield_s 6;		// short de/berlios/jmds/applet/SCAppletWithKey.messLength
-					getfield_s_this 6;		// short de/berlios/jmds/applet/SCAppletWithKey.messLength
-					newarray 11;
-					astore_2;
-					sconst_0;
+				L0:	aload_1;
+					invokevirtual 12;		// javacard/framework/APDU.setIncomingAndReceive()S
+					sstore_2;
+					getfield_a_this 10;		// reference de/berlios/jmds/applet/SCAppletWithKey.cipher
+					getfield_a_this 7;		// reference de/berlios/jmds/applet/SCAppletWithKey.userKey
+					sconst_2;
+					invokevirtual 33;		// javacardx/crypto/Cipher.init(Ljavacard/security/Key;B)V
+					getfield_a_this 10;		// reference de/berlios/jmds/applet/SCAppletWithKey.cipher
+					getfield_a_this 11;		// reference de/berlios/jmds/applet/SCAppletWithKey.buffer
+					sconst_5;
+					sload_2;
+					getfield_a_this 11;		// reference de/berlios/jmds/applet/SCAppletWithKey.buffer
+					sconst_5;
+					invokevirtual 34;		// javacardx/crypto/Cipher.doFinal([BSS[BS)S
 					sstore_3;
-					goto L2;
-				L1:	aload_2;
+					aload_1;
+					invokevirtual 14;		// javacard/framework/APDU.setOutgoing()S
+					sstore 4;
+					sload 4;
 					sload_3;
-					getfield_a_this 4;		// reference de/berlios/jmds/applet/SCAppletWithKey.buffer
-					sload_3;
-					sconst_5;
-					sadd;
-					baload;
-					bspush 16;
-					sand;
-					bastore;
-					sinc 3 1;
-				L2:	sload_3;
-					getfield_s_this 6;		// short de/berlios/jmds/applet/SCAppletWithKey.messLength
-					if_scmplt L1;
-				L3:	return;
-		}
-
-		.method private getEncode(Ljavacard/framework/APDU;)V {
-			.stack 4;
-			.locals 0;
-
-			.descriptor	Ljavacard/framework/APDU;	0.10;
-
-				L0:	aload_1;
-					invokevirtual 15;		// javacard/framework/APDU.setOutgoing()S
-					getfield_s_this 6;		// short de/berlios/jmds/applet/SCAppletWithKey.messLength
 					if_scmpge L2;
 				L1:	sspush 26368;
-					invokestatic 12;		// javacard/framework/ISOException.throwIt(S)V
+					invokestatic 31;		// javacard/framework/ISOException.throwIt(S)V
 				L2:	aload_1;
-					getfield_a_this 5;		// reference de/berlios/jmds/applet/SCAppletWithKey.code
-					sconst_0;
-					getfield_s_this 6;		// short de/berlios/jmds/applet/SCAppletWithKey.messLength
-					invokevirtual 17;		// javacard/framework/APDU.sendBytesLong([BSS)V
+					sload_3;
+					invokevirtual 15;		// javacard/framework/APDU.setOutgoingLength(S)V
+					aload_1;
+					getfield_a_this 11;		// reference de/berlios/jmds/applet/SCAppletWithKey.buffer
+					sconst_5;
+					sload_3;
+					invokevirtual 16;		// javacard/framework/APDU.sendBytesLong([BSS)V
 					return;
 		}
 

Modified: trunk/generator/SecurityApplet.pmf
===================================================================
--- trunk/generator/SecurityApplet.pmf	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/generator/SecurityApplet.pmf	2005-02-26 22:55:15 UTC (rev 44)
@@ -7,5 +7,5 @@
 ClassDir=d:\1G2K - SOPRA\IR3\Corba\jmds\SVN\trunk\classes
 [Applets]
 NumApplets=1
-Applet1=SCApplet.class
+Applet1=SCAppletWithKey.class
 Applet1AID=11223344556677

Added: trunk/lib/jc_api_212.jar
===================================================================
(Binary files differ)


Property changes on: trunk/lib/jc_api_212.jar
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/src/de/berlios/jmds/applet/SCApplet.java
===================================================================
--- trunk/src/de/berlios/jmds/applet/SCApplet.java	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/src/de/berlios/jmds/applet/SCApplet.java	2005-02-26 22:55:15 UTC (rev 44)
@@ -52,7 +52,7 @@
      * @see javacard.framework.Applet#install(byte[], short, byte)
      */
     public static void install(byte[] bArray, short bOffset, byte bLength) {
-        new SCAppletWithKey();
+        new SCApplet();
     }
 
     /**
@@ -64,7 +64,7 @@
      * @see javacard.framework.Applet#process(javacard.framework.APDU)
      */
     public void process(APDU apdu) throws ISOException {
-        byte[] buffer = apdu.getBuffer();
+        buffer = apdu.getBuffer();
 
         if (buffer[ISO7816.OFFSET_CLA] == CLA_SECURITY) {
             switch (buffer[ISO7816.OFFSET_INS]) {
@@ -72,16 +72,9 @@
                     encode(apdu);
                     break;
                 
-                case INS_GET_CODE:
-                    getEncode(apdu);
-                    break;
-
                 case INS_DECODE:
                     break;
                     
-                case INS_GET_DECODE:
-                    break;
-                    
                 case INS_SET_USER_KEY:
                     break;
                     
@@ -100,10 +93,7 @@
         for (short i = 0; i &lt; messLength; i++) {
             code[(short)(i + key)] = buffer[(short)(i + ISO7816.OFFSET_CDATA)];
         }
-    }
-    
-    private void getEncode(APDU apdu)
-    {
+        
         short Le = apdu.setOutgoing();
         // Verification que Le &gt;= Lc (taille des donn&#233;es envoy&#233;es)
         if (Le &lt; BUFFER_LENGTH)

Added: trunk/src/de/berlios/jmds/applet/SCAppletWithKey.java
===================================================================
--- trunk/src/de/berlios/jmds/applet/SCAppletWithKey.java	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/src/de/berlios/jmds/applet/SCAppletWithKey.java	2005-02-26 22:55:15 UTC (rev 44)
@@ -0,0 +1,190 @@
+/*
+ * Created on 8 f&#233;vr. 2005
+ * by J&#233;r&#244;me GUERS
+ * Copyright: GPL - UMLV(FR) - 2004/2005
+ */
+package de.berlios.jmds.applet;
+
+import javacard.framework.APDU;
+import javacard.framework.Applet;
+import javacard.framework.ISOException;
+import javacard.framework.ISO7816;
+import javacard.security.KeyBuilder;
+import javacard.security.RSAPrivateKey;
+import javacard.security.RSAPublicKey;
+import javacardx.crypto.*;
+
+/**
+ * DOCME
+ * 
+ * @version 0.1
+ * 
+ * @author J&#233;r&#244;me GUERS
+ */
+public class SCAppletWithKey extends Applet {
+
+    private final static byte CLA_SECURITY = (byte) 0x69;
+    private final static byte CODE = (byte) 0x10;
+    private final static byte DECODE = (byte) 0x30;
+
+    private final static short BUFFER_LENGTH = (short) 255;
+
+    private byte[] buffer;
+    private byte[] privateCode;
+    private byte[] code;
+    private short messLength;
+    
+    private RSAPrivateKey userKey;
+    private RSAPublicKey serverKey;
+    private RSAPrivateKey sessionKey;
+    private Cipher cipher;
+    
+//  Private Key definition
+    static byte[] rsaPrivateKey = //Note this is 338 bytes long and is a 1024 bit CRT formatted Private key
+          {
+          (byte)0xC2, (byte)0x01, (byte)0x05,
+          (byte)0xC2, (byte)0x41, (byte)0x00,
+          (byte)0xC5, (byte)0xD7, (byte)0x20, (byte)0x28, (byte)0xFA, (byte)0xA7, (byte)0x91, (byte)0x55, 
+          (byte)0x23, (byte)0xE2, (byte)0x0D, (byte)0xE4, (byte)0x28, (byte)0x7C, (byte)0x65, (byte)0xB7,
+          (byte)0x18, (byte)0x59, (byte)0xD9, (byte)0x0D, (byte)0xBA, (byte)0xE7, (byte)0xCF, (byte)0x6A, 
+          (byte)0xF1, (byte)0xE3, (byte)0x10, (byte)0xC3, (byte)0x7E, (byte)0x48, (byte)0x0D, (byte)0xBC,
+          (byte)0x76, (byte)0x7B, (byte)0x04, (byte)0x86, (byte)0xB6, (byte)0x7F, (byte)0xCD, (byte)0x6C, 
+          (byte)0x84, (byte)0x1A, (byte)0x0B, (byte)0x86, (byte)0xB9, (byte)0x96, (byte)0xAA, (byte)0x83,
+          (byte)0x68, (byte)0x63, (byte)0x3C, (byte)0x4D, (byte)0x43, (byte)0x84, (byte)0xB8, (byte)0x6D, 
+          (byte)0x48, (byte)0xAA, (byte)0xC4, (byte)0xC9, (byte)0x1B, (byte)0x50, (byte)0x47, (byte)0x49,
+          (byte)0xC2, (byte)0x41, (byte)0x00,
+          (byte)0xC9, (byte)0x5E, (byte)0x4A, (byte)0x08, (byte)0x0E, (byte)0xDC, (byte)0xA5, (byte)0x45, 
+          (byte)0x90, (byte)0x1C, (byte)0x52, (byte)0xF8, (byte)0x3E, (byte)0xB0, (byte)0x6B, (byte)0x8F,
+          (byte)0xCF, (byte)0xEA, (byte)0xA8, (byte)0xF5, (byte)0x1E, (byte)0xAD, (byte)0xD3, (byte)0x82, 
+          (byte)0x52, (byte)0x30, (byte)0x43, (byte)0x04, (byte)0x9C, (byte)0x25, (byte)0x63, (byte)0x87,
+          (byte)0x37, (byte)0x20, (byte)0x64, (byte)0x3F, (byte)0x16, (byte)0xB0, (byte)0x50, (byte)0xCC, 
+          (byte)0x38, (byte)0x06, (byte)0x1B, (byte)0xDF, (byte)0xE6, (byte)0x78, (byte)0xC3, (byte)0x99,
+          (byte)0xF7, (byte)0xC4, (byte)0x3F, (byte)0x95, (byte)0x81, (byte)0xE0, (byte)0x77, (byte)0x5C, 
+          (byte)0xA3, (byte)0x78, (byte)0xB8, (byte)0x9C, (byte)0x8D, (byte)0x9B, (byte)0x46, (byte)0x5D,
+          (byte)0xC2, (byte)0x41, (byte)0x00,
+          (byte)0x7F, (byte)0xDE, (byte)0x17, (byte)0x36, (byte)0xDA, (byte)0x18, (byte)0x1E, (byte)0xEF, 
+          (byte)0xD0, (byte)0x50, (byte)0xBD, (byte)0x2C, (byte)0x57, (byte)0xBE, (byte)0x10, (byte)0x7B,
+          (byte)0x08, (byte)0x7D, (byte)0xC6, (byte)0xC7, (byte)0xF5, (byte)0x76, (byte)0xA2, (byte)0x59, 
+          (byte)0x35, (byte)0x7D, (byte)0xEA, (byte)0xB0, (byte)0x73, (byte)0xE6, (byte)0x51, (byte)0xEB,
+          (byte)0xD3, (byte)0x07, (byte)0xDD, (byte)0x73, (byte)0x56, (byte)0x8B, (byte)0x76, (byte)0x46, 
+          (byte)0x3F, (byte)0xAE, (byte)0x0A, (byte)0xB9, (byte)0xA3, (byte)0xE3, (byte)0x0D, (byte)0x71,
+          (byte)0xFB, (byte)0xFE, (byte)0x55, (byte)0x02, (byte)0xF6, (byte)0xB6, (byte)0x4D, (byte)0xC2, 
+          (byte)0x79, (byte)0x64, (byte)0xFD, (byte)0x28, (byte)0xBB, (byte)0x13, (byte)0x23, (byte)0xB2,
+          (byte)0xC2, (byte)0x41, (byte)0x00,
+          (byte)0xA3, (byte)0x8D, (byte)0xA3, (byte)0xED, (byte)0x9C, (byte)0xC2, (byte)0x18, (byte)0xB8, 
+          (byte)0x9D, (byte)0x10, (byte)0x8D, (byte)0x51, (byte)0x58, (byte)0x52, (byte)0xF6, (byte)0xB7,
+          (byte)0xB5, (byte)0xEE, (byte)0xD9, (byte)0x2C, (byte)0xAB, (byte)0x9E, (byte)0x65, (byte)0xEF, 
+          (byte)0xD0, (byte)0x86, (byte)0x59, (byte)0xDE, (byte)0x73, (byte)0xB0, (byte)0x57, (byte)0x82,
+          (byte)0xBD, (byte)0x24, (byte)0x17, (byte)0xEA, (byte)0xD2, (byte)0x46, (byte)0xB7, (byte)0x69, 
+          (byte)0x85, (byte)0x90, (byte)0x0E, (byte)0x85, (byte)0x53, (byte)0x3A, (byte)0x06, (byte)0x3E,
+          (byte)0xDA, (byte)0x76, (byte)0x67, (byte)0x6C, (byte)0xAC, (byte)0x6B, (byte)0xB5, (byte)0x17, 
+          (byte)0xCB, (byte)0x62, (byte)0x39, (byte)0x8A, (byte)0xD4, (byte)0x04, (byte)0xBA, (byte)0xD9,
+          (byte)0xC2, (byte)0x41, (byte)0x00,
+          (byte)0x44, (byte)0x03, (byte)0x03, (byte)0xB0, (byte)0x1B, (byte)0x0C, (byte)0xED, (byte)0x09, 
+          (byte)0x44, (byte)0xB6, (byte)0x3C, (byte)0x53, (byte)0xBA, (byte)0x20, (byte)0xAE, (byte)0x03,
+          (byte)0xA1, (byte)0xAE, (byte)0xD9, (byte)0x28, (byte)0x09, (byte)0x17, (byte)0x9E, (byte)0xC3, 
+          (byte)0x7A, (byte)0x6C, (byte)0xF0, (byte)0x85, (byte)0xC3, (byte)0x13, (byte)0x61, (byte)0xBD,
+          (byte)0x4E, (byte)0xA2, (byte)0x33, (byte)0x19, (byte)0x97, (byte)0xD9, (byte)0x2F, (byte)0x40, 
+          (byte)0xFA, (byte)0x7F, (byte)0x1D, (byte)0xB5, (byte)0x0E, (byte)0xCB, (byte)0xA5, (byte)0x0D,
+          (byte)0x00, (byte)0xC1, (byte)0x18, (byte)0xD4, (byte)0xAF, (byte)0x4C, (byte)0x18, (byte)0x24, 
+          (byte)0x82, (byte)0xD6, (byte)0x08, (byte)0x4C, (byte)0x60, (byte)0x0B, (byte)0x9C, (byte)0xC5
+          };
+
+//  Public Key definition
+    static byte[] rsaPublicKey = //Note this is 140 bytes long and is a modulus exponent formatted 1024 bit Public key
+          {
+          (byte)0xC1, (byte)0x01, (byte)0x05,
+          (byte)0xC0, (byte)0x81, (byte)0x00,
+          (byte)0x9B, (byte)0x9E, (byte)0xC6, (byte)0x74, (byte)0x65, (byte)0x5A, (byte)0xBC, (byte)0xBA, 
+          (byte)0xC6, (byte)0xB0, (byte)0x5D, (byte)0x3C, (byte)0x24, (byte)0x3C, (byte)0x90, (byte)0x59,
+          (byte)0x7D, (byte)0x5B, (byte)0x6D, (byte)0x03, (byte)0x7B, (byte)0xAD, (byte)0x9A, (byte)0xB4, 
+          (byte)0x58, (byte)0xFE, (byte)0x80, (byte)0x22, (byte)0xEC, (byte)0xF0, (byte)0xAB, (byte)0x84,
+          (byte)0xF9, (byte)0x07, (byte)0x84, (byte)0x91, (byte)0xE2, (byte)0x08, (byte)0xA6, (byte)0x9B, 
+          (byte)0xED, (byte)0xD7, (byte)0x45, (byte)0xC9, (byte)0xDD, (byte)0xBF, (byte)0xF8, (byte)0x7A,
+          (byte)0x8B, (byte)0xE1, (byte)0x17, (byte)0xCD, (byte)0x3D, (byte)0xD3, (byte)0x6F, (byte)0xB2, 
+          (byte)0x59, (byte)0x0C, (byte)0x0E, (byte)0x47, (byte)0x0B, (byte)0x8E, (byte)0x83, (byte)0xC5, 
+          (byte)0x0F, (byte)0xAF, (byte)0xD8, (byte)0x21, (byte)0x0C, (byte)0xD1, (byte)0x0B, (byte)0xB4, 
+          (byte)0x24, (byte)0x8D, (byte)0x66, (byte)0xAC, (byte)0x93, (byte)0xA3, (byte)0xE4, (byte)0x61, 
+          (byte)0xEF, (byte)0x26, (byte)0x50, (byte)0x1C, (byte)0x30, (byte)0xED, (byte)0x73, (byte)0xF1, 
+          (byte)0x92, (byte)0xD8, (byte)0x2C, (byte)0xC6, (byte)0x38, (byte)0xD4, (byte)0x6D, (byte)0x81, 
+          (byte)0x48, (byte)0x2B, (byte)0xCC, (byte)0x42, (byte)0xF8, (byte)0x60, (byte)0x61, (byte)0xAD, 
+          (byte)0x8D, (byte)0x7F, (byte)0x8D, (byte)0x6D, (byte)0x87, (byte)0xBF, (byte)0x7D, (byte)0x1C, 
+          (byte)0x61, (byte)0x2B, (byte)0xC0, (byte)0x42, (byte)0x47, (byte)0xDB, (byte)0xDD, (byte)0xC9, 
+          (byte)0x3F, (byte)0x07, (byte)0x23, (byte)0xE1, (byte)0x3D, (byte)0xDA, (byte)0xDB, (byte)0x85, 
+          (byte)0xC0, (byte)0x04, (byte)0x00,
+          (byte)0x01, (byte)0x00, (byte)0x01,
+          };
+    
+    /**
+     * Constructeur par d&#233;faut
+     */
+    protected SCAppletWithKey() {
+        privateCode = new byte[BUFFER_LENGTH];
+        code = new byte[BUFFER_LENGTH];
+        messLength = (byte) 0;
+        userKey = (RSAPrivateKey) KeyBuilder.buildKey(KeyBuilder.TYPE_RSA_PRIVATE, KeyBuilder.LENGTH_RSA_512, true);
+        userKey.setExponent(rsaPrivateKey, (short)5, (short) 12);
+        userKey.setModulus(rsaPrivateKey, (short)127, (short) 6);
+        serverKey = (RSAPublicKey) KeyBuilder.buildKey(KeyBuilder.TYPE_RSA_PUBLIC, KeyBuilder.LENGTH_RSA_512, true);
+        sessionKey = null;
+
+        cipher = Cipher.getInstance(Cipher.ALG_RSA_ISO9796, false);
+        register();
+    }
+
+    /**
+     * @see javacard.framework.Applet#install(byte[], short, byte)
+     */
+    public static void install(byte[] bArray, short bOffset, byte bLength) {
+        new SCAppletWithKey();
+    }
+
+    /**
+     * M&#233;thode appel&#233;e &#224; l'arriv&#233;e d'une trame APDU
+     * 
+     * @param apdu
+     * @throws ISOException
+     * 
+     * @see javacard.framework.Applet#process(javacard.framework.APDU)
+     */
+    public void process(APDU apdu) throws ISOException {
+        buffer = apdu.getBuffer();
+
+        if (buffer[ISO7816.OFFSET_CLA] == CLA_SECURITY) {
+            switch (buffer[ISO7816.OFFSET_INS]) {
+                case CODE:
+                    encode(apdu);
+                    break;
+      
+                case DECODE:
+                    break;
+            }
+        }
+    }
+    
+    private void encode(APDU apdu)
+    {
+        short byteRead = (short)(apdu.setIncomingAndReceive());
+        
+        cipher.init(userKey, Cipher.MODE_ENCRYPT);
+        short outbytes = cipher.doFinal(buffer,(short)ISO7816.OFFSET_CDATA, byteRead, buffer, (short)ISO7816.OFFSET_CDATA);    
+        
+        // Send results
+        short Le = apdu.setOutgoing();
+        if (Le &lt; outbytes)
+            ISOException.throwIt(ISO7816.SW_WRONG_LENGTH);
+
+        // indicate the number of bytes in the data field
+        apdu.setOutgoingLength((short)outbytes); 
+        // at offset 0 send 128 byte of data in the buffer
+        apdu.sendBytesLong(buffer, (short)ISO7816.OFFSET_CDATA, (short)outbytes);
+        
+//        messLength = apdu.setIncomingAndReceive();
+//        byte[] requestID = new byte[messLength];
+//        for (short i = 0; i &lt; messLength; i++) {
+//            requestID[i] = (byte)(buffer[(short)(i + ISO7816.OFFSET_CDATA)] &amp; 0x10);
+//        }
+//        cipher.init(userKey, Cipher.MODE_ENCRYPT);
+//        cipher.doFinal(requestID, (short)0, (short) requestID, )
+    }
+}

Modified: trunk/src/de/berlios/jmds/client/ClientInter.java
===================================================================
--- trunk/src/de/berlios/jmds/client/ClientInter.java	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/src/de/berlios/jmds/client/ClientInter.java	2005-02-26 22:55:15 UTC (rev 44)
@@ -14,6 +14,8 @@
 import org.omg.PortableInterceptor.ClientRequestInterceptor;
 import org.omg.PortableInterceptor.ForwardRequest;
 
+import slb.iop.slbException;
+
 /**
  * @author S&#233;bastien GUINCHARD
  * 
@@ -24,39 +26,31 @@
     /**
      * Comment for &lt;code&gt;serialVersionUID&lt;/code&gt;
      */
-    private static final long serialVersionUID = 3618417146430765111L;
+    private final static long serialVersionUID = 3618417146430765111L;
+    private final static SCAppletClient SC_APPLET = SCAppletClient.getInstance();
 
     //----------------------------------------------------------//
 	//------------------- PUBLIC METHODS -----------------------//
 	//----------------------------------------------------------//
     
     /**
+     * @throws slbException 
+     * @throws SecurityException 
      * @see org.omg.PortableInterceptor.ClientRequestInterceptorOperations#send_request(org.omg.PortableInterceptor.ClientRequestInfo)
      */
-    public void send_request(ClientRequestInfo ri) throws ForwardRequest {
-        ServiceContext sc = new ServiceContext ();
-        
-        System.out.println(&quot;ClientInter.send request: &quot; + ri.operation()
-                + &quot; number: &quot; + ri.request_id());
-        SCAppletClient scApplet = SCAppletClient.getInstance();
+    public void send_request(ClientRequestInfo ri) throws ForwardRequest, SecurityException{
         int id = ri.request_id();
-        byte[] tabId = new Integer(id).toString().getBytes();
-        System.out.println (tabId.length);
+        byte[] tabId = Integer.toString(id).getBytes();
 
-        byte[] tabByteSC = scApplet.code(tabId);
-        
-        //Test affichage
-        for(int i=0; i &lt; tabByteSC.length; i++) {
-        	System.out.print(tabByteSC[i]);
+        try {
+            byte[] tabByteSC = SC_APPLET.code(tabId);
+            
+            ServiceContext sc = new ServiceContext ();
+            sc.context_data = tabByteSC;
+            ri.add_request_service_context(sc,true);
+        } catch (slbException e) {
+            throw new SecurityException(&quot;Impossible de coder le message: erreur de communication avec la carte&quot;, e);
         }
-   
-        
-        if(tabByteSC == null) {
-        	throw new SecurityException(&quot;Impossible de coder le message: Verifier la pr&#233;sence de la carte dans le lecteur&quot;);
-        }
-        sc.context_data = tabByteSC;
-        ri.add_request_service_context(sc,true);
-        
     }
 
     /**
@@ -102,5 +96,4 @@
      */
     public void destroy() {
     }
-
 }

Modified: trunk/src/de/berlios/jmds/client/SCAppletClient.java
===================================================================
--- trunk/src/de/berlios/jmds/client/SCAppletClient.java	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/src/de/berlios/jmds/client/SCAppletClient.java	2005-02-26 22:55:15 UTC (rev 44)
@@ -15,198 +15,125 @@
 import slb.iop.IOPEvent;
 import slb.iop.IOPListener;
 import slb.iop.SmartCard;
+import slb.iop.slbException;
 
 /**
  * @author Denis
  * 
  */
 public class SCAppletClient {
-	
-	/** The singleton instance * */
-	private static SCAppletClient INSTANCE = null;
-	
-	
-    private static class jmdsIOPListener implements IOPListener {
 
-        /**
-		 * DOCME
-		 * 
-		 * @param arg0
-		 * 
-		 * @see slb.iop.IOPListener#CardRemoved(slb.iop.IOPEvent)
-		 */
+    /** The singleton instance * */
+    private final static SCAppletClient INSTANCE = new SCAppletClient();
+
+    private final static IOP APPLET_IOP = new IOP();
+    private final static short[] APPLET_AID = {
+            (short) 0x11, (short) 0x22, (short) 0x33, 
+            (short) 0x44, (short) 0x55, (short) 0x66, (short) 0x77 };
+
+    private static SmartCard card = null;
+
+    private static int CLA;
+    private static int INS;
+    private static int P1;
+    private static int P2;
+    private static int[] body;
+    private static int LE;
+
+    private static class jmdsIOPListener implements IOPListener {
         public void CardRemoved(IOPEvent event) {
-            System.out.println(&quot;Carte retir&#233;e de &quot;);
-            System.out.println(event.getReaderName());
+            findCard();
         }
 
-        /**
-		 * DOCME
-		 * 
-		 * @param arg0
-		 * 
-		 * @see slb.iop.IOPListener#CardInserted(slb.iop.IOPEvent)
-		 */
         public void CardInserted(IOPEvent event) {
-            System.out.print(&quot;Carte ins&#233;r&#233;e dans &quot;);
-            System.out.println(event.getReaderName());
+            findCard();
         }
-        
-        /**
-         * DOCME
-         * 
-         * @param arg0
-         * 
-         * @see slb.iop.IOPListener#ReaderRemoved(slb.iop.IOPEvent)
-         */
+
         public void ReaderRemoved(IOPEvent event) {
-            System.out.println(&quot;Lecteur d&#233;connect&#233;&quot;);
+            findCard();
         }
 
-        /**
-         * DOCME
-         * 
-         * @param arg0
-         * 
-         * @see slb.iop.IOPListener#ReaderInserted(slb.iop.IOPEvent)
-         */
         public void ReaderInserted(IOPEvent event) {
-            System.out.println(&quot;Lecteur connect&#233;&quot;);
+            findCard();
         }
     }
 
-	// ----------------------------------------------------------//
-	// ------------------- CONSTRUCTORS -------------------------//
-	// ----------------------------------------------------------//
-	
-	/**
-	 * Constructor
-	 * 
-	 */
-	private SCAppletClient ()
-	{
-        IOP sIOP = new IOP();
+    // ----------------------------------------------------------//
+    // ------------------- CONSTRUCTORS -------------------------//
+    // ----------------------------------------------------------//
+    /**
+     * Constructor
+     * 
+     */
+    private SCAppletClient() {
+        APPLET_IOP.addIOPListener(new jmdsIOPListener());
+    }
 
-        jmdsIOPListener listener = new jmdsIOPListener();
-        sIOP.addIOPListener(listener);
-
-        String[] lstReaders = sIOP.ListReaders();
-
-        for (int i = 0; i &lt; lstReaders.length; i++) {
-            System.out.println(lstReaders[i]);
-        }
-
-        SmartCard card = new SmartCard();
-        if (lstReaders.length &gt; 0) {
-            boolean result = sIOP.Connect(card, lstReaders[0], false);
-            if (result) {
-                System.out.println(&quot;Carte connectee&quot;);
-
-                
-
-               
-
-                
-        
-            }
-        }
+    // ----------------------------------------------------------//
+    // ------------------- PUBLIC METHODS -----------------------//
+    // ----------------------------------------------------------//
+    /**
+     * To get the singleton instance of LDAP
+     * 
+     * @return the singleton instance of LDAP
+     */
+    public static SCAppletClient getInstance() {
+        return INSTANCE;
     }
-	
-	// ----------------------------------------------------------//
-	// ------------------- PUBLIC METHODS -----------------------//
-	// ----------------------------------------------------------//
 
-	
-	/**
-	 * To get the singleton instance of LDAP
-	 * 
-	 * @return the singleton instance of LDAP
-	 */
-	public static SCAppletClient getInstance ()
-	{
-		if (INSTANCE == null)
-			INSTANCE = new SCAppletClient ();
-		
-		return INSTANCE;
-	}
-	
-	/**
-	 * @param requestId
-	 *            as id of the request message
-	 * @return The array byte which contains the encoding servec context
-	 */
-	public byte[] code (byte[] requestId)
-	{
-		IOP sIOP = new IOP();
+    /**
+     * @param requestId
+     *            as id of the request message
+     * @return The array byte which contains the encoding servec context
+     * @throws slbException 
+     * @throws SecurityException 
+     */
+    public byte[] code(byte[] requestId) throws SecurityException, slbException {
+        // Envoi de l'APDU CODE
+        CLA = Integer.parseInt(&quot;69&quot;, 16);
+        INS = Integer.parseInt(&quot;10&quot;, 16);
+        P1 = Integer.parseInt(&quot;00&quot;, 16);
+        P2 = Integer.parseInt(&quot;00&quot;, 16);
+        body = Convertor.stringToIntArray(&quot;73119&quot;);
+        LE = Integer.parseInt(&quot;00&quot;, 16);
+        System.out.println(&quot; body: &quot; + requestId.toString());
 
-        jmdsIOPListener listener = new jmdsIOPListener();
-        sIOP.addIOPListener(listener);
+        sendCardAPDU(card, CLA, INS, P1, P2, body, LE);
 
-        String[] lstReaders = sIOP.ListReaders();
-
-        for (int i = 0; i &lt; lstReaders.length; i++) {
-            System.out.println(lstReaders[i]);
-        }
-
-        SmartCard card = new SmartCard();
-        if (lstReaders.length &gt; 0) {
-            boolean result = sIOP.Connect(card, lstReaders[0], false);
-            if (result) {
-            	//Initialisation
-            	int CLA = Integer.parseInt(&quot;00&quot;, 16);
-                int INS = Integer.parseInt(&quot;A4&quot;, 16);
-                int P1 = Integer.parseInt(&quot;04&quot;, 16);
-                int P2 = Integer.parseInt(&quot;00&quot;, 16);
-                int[] body = Convertor.stringToIntArray(&quot;11223344556677&quot;);
-                int LE = Integer.parseInt(&quot;00&quot;, 16);
-                sendCardAPDU(card,CLA,INS,P1,P2,body,LE);
-                
-		        //Envoi de l'APDU CODE
-		        CLA = Integer.parseInt(&quot;69&quot;, 16);
-		        INS = Integer.parseInt(&quot;10&quot;, 16);
-		        P1 = Integer.parseInt(&quot;00&quot;, 16);
-		        P2 = Integer.parseInt(&quot;00&quot;, 16);
-		        body = Convertor.stringToIntArray(&quot;73119&quot;);
-		        LE = Integer.parseInt(&quot;00&quot;, 16);
-		        System.out.println (&quot; body: &quot; +requestId.toString());
-        
-		        sendCardAPDU(card,CLA,INS,P1,P2,body,LE);
-		        
-		        //Envoi de l'APDU GETCODE
-		        System.out.print(&quot;Envoi de l'APDU Get Code: &gt; &quot;);
-		        CLA = (int) Integer.parseInt(&quot;69&quot;, 16);
-		        INS = (int) Integer.parseInt(&quot;11&quot;, 16);
-		        P1 = (int) Integer.parseInt(&quot;00&quot;, 16);
-		        P2 = (int) Integer.parseInt(&quot;00&quot;, 16);
-		        body = Convertor.stringToIntArray(&quot;&quot;);
-		        LE = (int) Integer.parseInt(&quot;20&quot;, 16);
-		        short [] code = sendCardAPDU(card,CLA,INS,P1,P2,body,LE);
-		        if(code != null)
-		        	return Convertor.shortArrayToByteArray(code);
-            }
-        }
+        // Envoi de l'APDU GETCODE
+        System.out.print(&quot;Envoi de l'APDU Get Code: &gt; &quot;);
+        CLA = (int) Integer.parseInt(&quot;69&quot;, 16);
+        INS = (int) Integer.parseInt(&quot;11&quot;, 16);
+        P1 = (int) Integer.parseInt(&quot;00&quot;, 16);
+        P2 = (int) Integer.parseInt(&quot;00&quot;, 16);
+        body = Convertor.stringToIntArray(&quot;&quot;);
+        LE = (int) Integer.parseInt(&quot;20&quot;, 16);
+        short[] code = sendCardAPDU(card, CLA, INS, P1, P2, body, LE);
+        if (code != null)
+            return Convertor.shortArrayToByteArray(code);
         return null;
-	}
-	
-	/**
-	 * @param SC
-	 *            as the message service context
-	 * @return the request id of the message
-	 */
-	public byte[] decode (byte[] SC)
-	{
-//		Envoi de l'APDU CODE
+    }
+
+    /**
+     * @param SC
+     *            as the message service context
+     * @return the request id of the message
+     * @throws slbException 
+     * @throws SecurityException 
+     */
+    public byte[] decode(byte[] SC) throws SecurityException, slbException {
+        // Envoi de l'APDU CODE
         int CLA = Integer.parseInt(&quot;69&quot;, 16);
         int INS = Integer.parseInt(&quot;10&quot;, 16);
         int P1 = Integer.parseInt(&quot;00&quot;, 16);
         int P2 = Integer.parseInt(&quot;00&quot;, 16);
         int[] body = Convertor.stringToIntArray(&quot;6&quot;);
         int LE = Integer.parseInt(&quot;00&quot;, 16);
-        
+
         SmartCard card = new SmartCard();
-        sendCardAPDU(card,CLA,INS,P1,P2,body,LE);
-        
-        //Envoi de l'APDU getCode
+        sendCardAPDU(card, CLA, INS, P1, P2, body, LE);
+
+        // Envoi de l'APDU getCode
         System.out.print(&quot;Envoi de l'APDU Get Code: &gt; &quot;);
         CLA = (int) Integer.parseInt(&quot;69&quot;, 16);
         INS = (int) Integer.parseInt(&quot;11&quot;, 16);
@@ -214,37 +141,89 @@
         P2 = (int) Integer.parseInt(&quot;00&quot;, 16);
         body = Convertor.stringToIntArray(&quot;&quot;);
         LE = (int) Integer.parseInt(&quot;20&quot;, 16);
-        short [] code = sendCardAPDU(card,CLA,INS,P1,P2,body,LE);
-        
+        short[] code = sendCardAPDU(card, CLA, INS, P1, P2, body, LE);
+
         SC = Convertor.shortArrayToByteArray(code);
-		return SC;			
-	}
-	
-	
-	/**
-	 * @param card 
-	 * @param LE 
-	 * @param body 
-	 * @param P2 
-	 * @param P1 
-	 * @param INS 
-	 * @param CLA 
-	 * @return out the result of the sendCardAPDU call
-	 * 
-	 */
-	private short[] sendCardAPDU (SmartCard card, int CLA, int INS, int P1, int P2, int [] body, int LE)
-	{
-		short[] out=null;
-		try {
-            System.out.println(&quot;Applet Selection&quot;);
-            card.BeginTransaction();
-            out = card.SendCardAPDU(CLA, INS, P1, P2, body, LE);
-            System.out.println(&quot;Applet selected&quot;);
-            card.EndTransaction();
-        } catch (slb.iop.slbException e) {
-            System.out.println(&quot;Pb de Selection&quot;);
-            e.printStackTrace();
-        }
+        return SC;
+    }
+
+    /**
+     * @param card
+     * @param LE
+     * @param body
+     * @param P2
+     * @param P1
+     * @param INS
+     * @param CLA
+     * @return out the result of the sendCardAPDU call
+     * @throws slbException
+     * 
+     */
+    private final static short[] sendCardAPDU(SmartCard card, int CLA, int INS,
+            int P1, int P2, int[] body, int LE) throws slbException,
+            SecurityException {
+        if (card == null)
+            throw new SecurityException(&quot;Pas de carte disponible !&quot;);
+
+        // Initialisation
+        card.BeginTransaction();
+        if (!card.SelectAID(APPLET_AID)) // A v&#233;rifier. Je ne sais pas si &#231;a marche !!
+            throw new SecurityException(&quot;Pas d'applet de cryptage !&quot;);
+        // CLA = Integer.parseInt(&quot;00&quot;, 16);
+        // INS = Integer.parseInt(&quot;A4&quot;, 16);
+        // P1 = Integer.parseInt(&quot;04&quot;, 16);
+        // P2 = Integer.parseInt(&quot;00&quot;, 16);
+        // body = Convertor.stringToIntArray(&quot;11223344556677&quot;);
+        // LE = Integer.parseInt(&quot;00&quot;, 16);
+        // sendCardAPDU(card,CLA,INS,P1,P2,body,LE);
+        short[] out = card.SendCardAPDU(CLA, INS, P1, P2, body, LE);
+        card.EndTransaction();
         return out;
-	}
+    }
+    
+    /**
+     * Recherche d'une carte ayant notre applet instanci&#233;
+     */
+    private final static void findCard()
+    {
+        String[] lstReaders = APPLET_IOP.ListReaders();
+        int i = 0;
+        while ((i &lt; lstReaders.length) &amp;&amp; (card == null)) {
+            card = new SmartCard();
+            boolean result = APPLET_IOP.Connect(card, lstReaders[i], false);
+            if (result) {
+                short[] MACKey = Convertor.HexStringToShortArray(&quot;404142434445464748494A4B4C4D4E4F&quot;);
+                short[] autKey = Convertor.HexStringToShortArray(&quot;404142434445464748494A4B4C4D4E4F&quot;);
+                short[] KEKKey = Convertor.HexStringToShortArray(&quot;404142434445464748494A4B4C4D4E4F&quot;);
+
+                try {
+                    card.BeginTransaction();
+                    card.EstablishSecureChannel(MACKey, autKey, KEKKey);
+                    short shortAID[] = card.EnumerateAID((byte) 0x40);
+
+                    short[] shortListAID;
+
+                    int z = 0;
+                    for (int y = 0; y &lt; shortAID.length; y = z) {
+                        shortListAID = new short[shortAID[y]];
+                        z = z + shortListAID.length + 3;
+                        for (int x = 0; x &lt; shortListAID.length; x++) {
+                            shortListAID[x] = shortAID[x + y + 1];
+                        }
+
+                        if ((shortAID[z - 1] &amp; (byte) 0x80) != 1) {
+                            if(!APPLET_AID.equals(shortListAID))
+                                card = null;
+                        }
+                    }
+
+                    card.EndTransaction();
+                } catch (slbException e) {
+                    card = null;
+                }
+            } else
+                card = null;
+            i++;
+        }
+    }
 }

Modified: trunk/src/de/berlios/jmds/tools/Convertor.java
===================================================================
--- trunk/src/de/berlios/jmds/tools/Convertor.java	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/src/de/berlios/jmds/tools/Convertor.java	2005-02-26 22:55:15 UTC (rev 44)
@@ -11,49 +11,24 @@
 package de.berlios.jmds.tools;
 
 /**
- * Permet la conversion de String en short[] et inversement
+ * Fournit des outils de conversions
  * 
  * @author J&#233;r&#244;me GUERS
  * 
  */
 public class Convertor {
-    
-	//----------------------------------------------------------//
-	//------------------- PUBLIC METHODS -----------------------//
-	//----------------------------------------------------------//    
-	
-	/**
-     * DOCME
-     * @param value 
-     * @return a table of short
-     */
-    public final static short[] stringToShortArray(String value) {
-        short shortKey[] = new short[(value.length() / 2)];
-        int y = 0;
-        String strShort;
 
-        for (int x = 0; x &lt; shortKey.length; x++) {
-            strShort = value.substring(y, (y + 2));
-            if (strShort.equals(&quot;FF&quot;)) {
-                shortKey[x] = (short) 0xFF;
-            } else {
-                try {
-                    shortKey[x] = (short) Short.parseShort(strShort, 16);
-                } catch (NumberFormatException e) {
-                    System.out.println(&quot;HexStringToShortArray Failed &quot;);
-                }
-            }
-            y = y + 2;
-        }
-        return shortKey;
-    }
-    
+    // ----------------------------------------------------------//
+    // ------------------- PUBLIC METHODS -----------------------//
+    // ----------------------------------------------------------//
+
     /**
      * DOCME
-     * @param value 
+     * 
+     * @param value
      * @return a table of int containing the stirng
      */
-    public static int[] stringToIntArray(String value) {
+    public final static int[] stringToIntArray(String value) {
         int intKey[] = new int[(value.length() / 2)];
         int y = 0;
         String strInt;
@@ -75,44 +50,69 @@
         return intKey;
     }
 
-	/**
-	 * @param context_data
-	 * @return string of the byte table
-	 */
-	public static String byteToString (byte [] context_data)
-	{
-		StringBuffer sb = new StringBuffer();
-		for(int i=0; i &lt; context_data.length; i++) {
-			sb.append(context_data[i]);
-		}
-		return sb.toString();
-	}
+    /**
+     * @param context_data
+     * @return string of the byte table
+     */
+    public final static String byteToString(byte[] context_data) {
+        StringBuffer sb = new StringBuffer();
+        for (int i = 0; i &lt; context_data.length; i++) {
+            sb.append(context_data[i]);
+        }
+        return sb.toString();
+    }
 
-	/**
-	 * @param code
-	 * @return a table of byte corresponding to the argument code
-	 */
-	public static byte [] shortArrayToByteArray (short [] code)
-	{
-		byte[] tmp = new byte[code.length];
-		for(int i=0; i&lt;code.length; i++) {
-			Short s = new Short(code[i]);
-			tmp[i]=s.byteValue();
-		}
-		return tmp;
-	}
+    /**
+     * @param code
+     * @return a table of byte corresponding to the argument code
+     */
+    public final static byte[] shortArrayToByteArray(short[] code) {
+        byte[] tmp = new byte[code.length];
+        for (int i = 0; i &lt; code.length; i++) {
+            Short s = new Short(code[i]);
+            tmp[i] = s.byteValue();
+        }
+        return tmp;
+    }
 
-	/**
-	 * @param requestId
-	 * @return the table of int
-	 */
-	public static int [] byteArrayToIntArray (byte [] requestId)
-	{
-		int[] tmp=null;
-		for(int i=0; i &lt; requestId.length; i++) {
-			tmp[i] = new Byte (requestId[i]).intValue();
-		}
-		return tmp;
-	}
+    /**
+     * @param requestId
+     * @return the table of int
+     */
+    public final static int[] byteArrayToIntArray(byte[] requestId) {
+        int[] tmp = null;
+        for (int i = 0; i &lt; requestId.length; i++) {
+            tmp[i] = new Byte(requestId[i]).intValue();
+        }
+        return tmp;
+    }
+
+    /**
+     * Parse la chaine en couple de deux chiffre et les converti en tableau de
+     * short
+     * 
+     * @param strHex
+     * @return
+     */
+    public final static short[] HexStringToShortArray(String strHex) {
+        short shortKey[] = new short[(strHex.length() / 2)];
+        int y = 0;
+        String strShort;
+
+        for (int x = 0; x &lt; shortKey.length; x++) {
+            strShort = strHex.substring(y, (y + 2));
+            if (strShort.equals(&quot;FF&quot;)) {
+                shortKey[x] = (short) 0xFF;
+            } else {
+                try {
+                    shortKey[x] = (short) Short.parseShort(strShort, 16);
+                } catch (NumberFormatException e) {
+                    System.out.println(&quot;HexStringToShortArray Failed &quot;);
+                }
+            }
+
+            y = y + 2;
+        }
+        return shortKey;
+    }
 }
-

Deleted: trunk/test/de/berlios/jmds/applet/SCAppletWithKey.java
===================================================================
--- trunk/test/de/berlios/jmds/applet/SCAppletWithKey.java	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/test/de/berlios/jmds/applet/SCAppletWithKey.java	2005-02-26 22:55:15 UTC (rev 44)
@@ -1,111 +0,0 @@
-/*
- * Created on 8 f&#233;vr. 2005
- * by J&#233;r&#244;me GUERS
- * Copyright: GPL - UMLV(FR) - 2004/2005
- */
-package de.berlios.jmds.applet;
-
-import javacard.framework.APDU;
-import javacard.framework.Applet;
-import javacard.framework.ISOException;
-import javacard.framework.ISO7816;
-import javacard.security.KeyBuilder;
-import javacard.security.RSAPrivateKey;
-import javacard.security.RSAPublicKey;
-//import javacardx.crypto.*;
-
-/**
- * DOCME
- * 
- * @version 0.1
- * 
- * @author J&#233;r&#244;me GUERS
- */
-public class SCAppletWithKey extends Applet {
-
-    private final static byte CLA_SECURITY = (byte) 0x69;
-    private final static byte CODE = (byte) 0x10;
-    private final static byte GET_CODE = (byte) 0x20;
-    private final static byte DECODE = (byte) 0x30;
-    private final static byte GET_DECODE = (byte) 0x40;
-    private final static short BUFFER_LENGTH = (short) 255;
-
-    private byte[] buffer;
-    private byte[] code;
-    private short messLength;
-    
-    private RSAPrivateKey userKey;
-    private RSAPublicKey serverKey;
-    private RSAPrivateKey sessionKey;
-    //private Cipher cipher;
-    
-    /**
-     * Constructeur par d&#233;faut
-     */
-    protected SCAppletWithKey() {
-        buffer = new byte[BUFFER_LENGTH];
-        code = new byte[BUFFER_LENGTH];
-        messLength = (byte) 0;
-        userKey = (RSAPrivateKey) KeyBuilder.buildKey(KeyBuilder.TYPE_RSA_PRIVATE, KeyBuilder.LENGTH_RSA_512, true);
-        serverKey = (RSAPublicKey) KeyBuilder.buildKey(KeyBuilder.TYPE_RSA_PUBLIC, KeyBuilder.LENGTH_RSA_512, true);
-        sessionKey = (RSAPrivateKey) KeyBuilder.buildKey(KeyBuilder.TYPE_RSA_PRIVATE, KeyBuilder.LENGTH_RSA_512, true);
-        //cipher = Cipher.getInstance(Cipher.ALG_RSA_ISO9796, false);
-        register();
-    }
-
-    /**
-     * @see javacard.framework.Applet#install(byte[], short, byte)
-     */
-    public static void install(byte[] bArray, short bOffset, byte bLength) {
-        new SCApplet();
-    }
-
-    /**
-     * M&#233;thode appel&#233;e &#224; l'arriv&#233;e d'une trame APDU
-     * 
-     * @param apdu
-     * @throws ISOException
-     * 
-     * @see javacard.framework.Applet#process(javacard.framework.APDU)
-     */
-    public void process(APDU apdu) throws ISOException {
-        byte[] buffer = apdu.getBuffer();
-
-        // CLA &#224; 69
-        if (buffer[ISO7816.OFFSET_CLA] == CLA_SECURITY) {
-            switch (buffer[ISO7816.OFFSET_INS]) {
-                case CODE:
-                    encode(apdu);
-                    break;
-                
-                case GET_CODE:
-                    getEncode(apdu);
-                    break;
-
-                case DECODE:
-                    break;
-                    
-                case GET_DECODE:
-                    break;
-            }
-        }
-    }
-    
-    private void encode(APDU apdu)
-    {
-        messLength = apdu.setIncomingAndReceive();
-        byte[] requestID = new byte[messLength];
-        for (short i = 0; i &lt; messLength; i++) {
-            requestID[i] = (byte)(buffer[(short)(i + ISO7816.OFFSET_CDATA)] &amp; 0x10);
-        }
-        //cipher.init(userKey, Cipher.MODE_ENCRYPT);
-    }
-    
-    private void getEncode(APDU apdu)
-    {
-        if(apdu.setOutgoing() &lt; messLength)
-            ISOException.throwIt(ISO7816.SW_WRONG_LENGTH);
-        
-        apdu.sendBytesLong(code, (short)0, messLength);
-    }
-}

Added: trunk/test/de/berlios/jmds/clients/TestSCApllet.java
===================================================================
--- trunk/test/de/berlios/jmds/clients/TestSCApllet.java	2005-02-25 20:55:20 UTC (rev 43)
+++ trunk/test/de/berlios/jmds/clients/TestSCApllet.java	2005-02-26 22:55:15 UTC (rev 44)
@@ -0,0 +1,79 @@
+/* 
+ * File    : SCManager.java
+ * Created : 18 f&#233;vr. 2005
+ * 
+ * =======================================
+ * JMDS PROJECT (&quot;<A HREF="http://jmds.berlios.de">http://jmds.berlios.de</A>&quot;)
+ * =======================================
+ *
+ */
+package de.berlios.jmds.clients;
+
+import slb.iop.IOP;
+import slb.iop.SmartCard;
+import de.berlios.jmds.tools.Convertor;
+
+/**
+ * DOCME
+ * @author J&#233;r&#244;me GUERS
+ * 
+ */
+public class TestSCApllet{
+
+    public static void main(String[] args) {
+        IOP sIOP = new IOP();
+
+        String[] lstReaders = sIOP.ListReaders();
+
+        for (int i = 0; i &lt; lstReaders.length; i++) {
+            System.out.println(lstReaders[i]);
+        }
+
+        SmartCard card = new SmartCard();
+        if (lstReaders.length &gt; 0) {
+            boolean result = sIOP.Connect(card, lstReaders[0], false);
+            if (result) {
+                System.out.println(&quot;Carte connectee&quot;);
+
+                int CLA = Integer.parseInt(&quot;00&quot;, 16);
+                int INS = Integer.parseInt(&quot;A4&quot;, 16);
+                int P1 = Integer.parseInt(&quot;04&quot;, 16);
+                int P2 = Integer.parseInt(&quot;00&quot;, 16);
+                int[] body = Convertor.stringToIntArray(&quot;11223344556677&quot;);
+                int LE = Integer.parseInt(&quot;00&quot;, 16);
+                try {
+                    System.out.println(&quot;Applet Selection&quot;);
+                    card.BeginTransaction();
+                    card.SendCardAPDU(CLA, INS, P1, P2, body, LE);
+                    System.out.println(&quot;Applet selected&quot;);
+                    card.EndTransaction();
+                } catch (slb.iop.slbException e) {
+                    System.out.println(&quot;Pb de Selection&quot;);
+                    e.printStackTrace();
+                }
+
+                System.out.println(&quot;Demande d'encodage&quot;);
+                CLA = Integer.parseInt(&quot;69&quot;, 16);
+                INS = Integer.parseInt(&quot;10&quot;, 16);
+                P1 = Integer.parseInt(&quot;00&quot;, 16);
+                P2 = Integer.parseInt(&quot;00&quot;, 16);
+                body = Convertor.stringToIntArray(&quot;102030&quot;);
+                LE = Integer.parseInt(&quot;FF&quot;, 16);
+
+                try {
+                    card.BeginTransaction();
+                    short[] out = card.SendCardAPDU(CLA, INS, P1, P2, body, LE);
+                    for (int i = 0; i &lt; out.length; i++) {
+                        System.out.print(Integer.toHexString(out[i]) + &quot; &quot;);
+                    }
+                    System.out.println(&quot;&quot;);
+                    card.EndTransaction();
+                } catch (slb.iop.slbException e) {
+                    System.out.println(&quot;Erreur codage&quot;);
+                    e.printStackTrace();
+                }
+            }
+        }
+    }
+}
+


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000056.html">[Jmds-svn] r43 - in trunk: . src/de/berlios/jmds/client src/de/berlios/jmds/server src/de/berlios/jmds/tools
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57">[ date ]</a>
              <a href="thread.html#57">[ thread ]</a>
              <a href="subject.html#57">[ subject ]</a>
              <a href="author.html#57">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/jmds-svn">More information about the Jmds-svn
mailing list</a><br>
</body></html>
